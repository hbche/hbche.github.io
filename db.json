{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"source/favicon.ico","path":"favicon.ico","modified":0,"renderable":0},{"_id":"themes/maupassant/source/css/copycode.scss","path":"css/copycode.scss","modified":0,"renderable":1},{"_id":"themes/maupassant/source/css/donate.scss","path":"css/donate.scss","modified":0,"renderable":1},{"_id":"themes/maupassant/source/css/search.scss","path":"css/search.scss","modified":0,"renderable":1},{"_id":"themes/maupassant/source/css/copyright.scss","path":"css/copyright.scss","modified":0,"renderable":1},{"_id":"themes/maupassant/source/css/style.scss","path":"css/style.scss","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/avatar.png","path":"img/avatar.png","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/alipay.svg","path":"img/alipay.svg","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/bitcoin.svg","path":"img/bitcoin.svg","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/github.svg","path":"img/github.svg","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/like.svg","path":"img/like.svg","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/paypal.svg","path":"img/paypal.svg","modified":0,"renderable":1},{"_id":"themes/maupassant/source/img/wechat.svg","path":"img/wechat.svg","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/codeblock-resizer.js","path":"js/codeblock-resizer.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/copycode.js","path":"js/copycode.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/copyright.js","path":"js/copyright.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/donate.js","path":"js/donate.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/fancybox.js","path":"js/fancybox.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/love.js","path":"js/love.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/recent-comments.js","path":"js/recent-comments.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/search.js","path":"js/search.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/share.js","path":"js/share.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/smartresize.js","path":"js/smartresize.js","modified":0,"renderable":1},{"_id":"themes/maupassant/source/js/totop.js","path":"js/totop.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/favicon.ico","hash":"98d04439770976a136c30243b25b28f6609b79b2","modified":1687946733650},{"_id":"source/_posts/hexo-basic.md","hash":"067c917be1ec6b655ce60d0f294a1427d708bf59","modified":1687944770977},{"_id":"source/_posts/hooks.md","hash":"76183c05b831a0836c82cec4b04cb617dee61b8c","modified":1687944770977},{"_id":"source/_posts/about.md","hash":"fb916c25048ef04c1b8cc0a406c5c76efb083da5","modified":1687944770977},{"_id":"source/_posts/promise-detail.md","hash":"0e62c1cd785c94517f8635db8ad2a87dcc500ca9","modified":1687944770978},{"_id":"source/_posts/sort-search.md","hash":"8017348cf485fa69b46ab90b9419b663a19c4c76","modified":1687944770978},{"_id":"source/react/01-Describing-The-UI.md","hash":"e87260ccaed941c44cc92d177d6c2be90f012ab6","modified":1687946981578},{"_id":"themes/maupassant/.gitignore","hash":"d7d27e5a9bcffe7f90dc2f4f0752e19020e40f40","modified":1687944856552},{"_id":"themes/maupassant/.travis.yml","hash":"f8da426b97088e4caa5226cff219a5d95087961f","modified":1687944856553},{"_id":"themes/maupassant/LICENSE","hash":"0663fd3a7ea9fc4f4c634b4d73e2da426b536f86","modified":1687944856553},{"_id":"themes/maupassant/README.md","hash":"c307cb96cd8331927cc1012fb0b3dfede2b113e8","modified":1687944856554},{"_id":"themes/maupassant/_config.yml","hash":"895390aa21d0646b23b53602a63a397accae2021","modified":1687944856554},{"_id":"themes/maupassant/package.json","hash":"5328c4c435cd4a5fe47caae31b9975013cdca5bb","modified":1687944856575},{"_id":"themes/maupassant/layout/archive.pug","hash":"8582db9eeebad1478db36f996292e2536b677694","modified":1687944856571},{"_id":"themes/maupassant/layout/base-without-sidebar.pug","hash":"c03e722ee31cd464cf2e6e39467bcdf398f4151f","modified":1687944856571},{"_id":"themes/maupassant/layout/base.pug","hash":"de21fa6e7ac20ef86c6ee93fc776f9ad5b164f21","modified":1687944856572},{"_id":"themes/maupassant/layout/blogroll.pug","hash":"f440c812d4a05c541fc1db9de1b6c9ae23f065c7","modified":1687944856572},{"_id":"themes/maupassant/layout/index.pug","hash":"a9459d749cc2ac6ac22275689856a370d6d278c9","modified":1687944856573},{"_id":"themes/maupassant/layout/page.pug","hash":"cb0aed2ea7892cdbc2f2ed7e3771e6a8229a31b8","modified":1687944856573},{"_id":"themes/maupassant/layout/post.pug","hash":"89724d1a1fa71feb55b4e75de6b8f1404267b7e7","modified":1687944856574},{"_id":"themes/maupassant/layout/single-column.pug","hash":"8b4b731cdf86379d526821a1fa950bf15ed61f15","modified":1687944856574},{"_id":"themes/maupassant/layout/timeline.pug","hash":"b041b77a941b788fad78d522d013bc158efe168c","modified":1687944856574},{"_id":"themes/maupassant/layout/tagcloud.pug","hash":"30e0191597d25ea88eb2f077f278caea61a47534","modified":1687944856574},{"_id":"themes/maupassant/languages/de-DE.yml","hash":"25d1d8cd8113045a7603c14af1ea1539fc6456ed","modified":1687944856555},{"_id":"themes/maupassant/languages/fr-FR.yml","hash":"3a50568f200b9c1258415b53727e42c6b6c7ea0b","modified":1687944856556},{"_id":"themes/maupassant/languages/en.yml","hash":"def65da84b131be40c090928ffd8186c71cf99a1","modified":1687944856556},{"_id":"themes/maupassant/languages/es-ES.yml","hash":"3cc9312fbdba4a8f8e8254804121e4724c719bcc","modified":1687944856556},{"_id":"themes/maupassant/languages/ko.yml","hash":"a454bcec60113507bc1d593a699849822386c196","modified":1687944856557},{"_id":"themes/maupassant/languages/nb-NO.yml","hash":"1812e3f7b22d3fe85238f3f61ab06efa755c7cc1","modified":1687944856557},{"_id":"themes/maupassant/languages/ru.yml","hash":"36edc014c6aaef367d58929089bf7915375e71a6","modified":1687944856558},{"_id":"themes/maupassant/languages/zh-CN.yml","hash":"17eec161e4dad1569890ad4a6af17ea7b13ea588","modified":1687944856558},{"_id":"themes/maupassant/languages/zh-TW.yml","hash":"c2064b65b4326d1ac8924405bad7f037e4ea2cf4","modified":1687944856558},{"_id":"themes/maupassant/layout/_partial/after_footer.pug","hash":"089e21f159835c977a1891572f7b3f96cea5758c","modified":1687944856559},{"_id":"themes/maupassant/layout/_partial/footer.pug","hash":"92aa15e813bfb411803cc54218feb5410469a9c2","modified":1687944856560},{"_id":"themes/maupassant/layout/_partial/comments.pug","hash":"afc0e55b3195762b0926799ed24f8147fcbd66f6","modified":1687944856559},{"_id":"themes/maupassant/layout/_partial/darkmode.pug","hash":"8a4c53229394ba6cf63afd427b4e6b1dc1156526","modified":1687944856560},{"_id":"themes/maupassant/layout/_partial/head.pug","hash":"08ee724c6258786088ae6a363d13fd8239b0bb77","modified":1687944856561},{"_id":"themes/maupassant/layout/_partial/helpers.pug","hash":"9e44f6d32f2449b4109c33118f8285fa2fc7b023","modified":1687944856562},{"_id":"themes/maupassant/layout/_partial/mathjax.pug","hash":"ac6e3a92bf18ab6bbd0e041b6796b295bae963ee","modified":1687944856563},{"_id":"themes/maupassant/layout/_partial/mathjax2.pug","hash":"de4515948d7cf10d3cca0e20e310c8b6cbb5d438","modified":1687944856564},{"_id":"themes/maupassant/layout/_partial/paginator.pug","hash":"03ad0c49ae6f8a999ae35b38d08e25775f51f52a","modified":1687944856564},{"_id":"themes/maupassant/layout/_partial/post_nav.pug","hash":"b11d9e6000449838b17f508429f29ffb60f53096","modified":1687944856565},{"_id":"themes/maupassant/layout/_partial/totop.pug","hash":"eb91a3baf9411188c7c8130f63a674f541ca9c81","modified":1687944856566},{"_id":"themes/maupassant/layout/_partial/tag.pug","hash":"c24f59230b18854daf847d39ce54c131b2f716c9","modified":1687944856565},{"_id":"themes/maupassant/layout/_partial/wordcount.pug","hash":"d7ebbdcee193e345e3f92539ddffd291a870b5f9","modified":1687944856566},{"_id":"themes/maupassant/layout/_widget/category.pug","hash":"e6bfc74e613f515dea534c22e4a9e1213c4db772","modified":1687944856567},{"_id":"themes/maupassant/layout/_widget/copyright.pug","hash":"4ee90ed25c0fb10d57ce3c58f8e4f725702637ef","modified":1687944856567},{"_id":"themes/maupassant/layout/_widget/donate.pug","hash":"e29fa0b74b8b01f6fe5ee827ab6d7dd25bb0accb","modified":1687944856567},{"_id":"themes/maupassant/layout/_widget/info.pug","hash":"55dd19e50bf78b90aa4013b38e676d1821cc7258","modified":1687944856568},{"_id":"themes/maupassant/layout/_widget/links.pug","hash":"2452cb2ffa159304a0d34c117250a4d12bd1b63f","modified":1687944856569},{"_id":"themes/maupassant/layout/_widget/recent_comments.pug","hash":"5aa5864bc86bd8c43c11cbec025456f8f123997c","modified":1687944856569},{"_id":"themes/maupassant/layout/_widget/recent_posts.pug","hash":"b717c372c8ff1285bcb87a4c28b318e9392bfbcc","modified":1687944856570},{"_id":"themes/maupassant/layout/_widget/search.pug","hash":"89ce6c4e34ab003662913aca3158a9e078feb6d5","modified":1687944856570},{"_id":"themes/maupassant/layout/_widget/tag.pug","hash":"6d82d3c0def86d8f9445c9542f52033d2378956e","modified":1687944856571},{"_id":"themes/maupassant/source/css/copycode.scss","hash":"23fefb18f1d4dc7bde33e29d6ae737570277d943","modified":1687944856575},{"_id":"themes/maupassant/source/css/donate.scss","hash":"d9ef1520e136198c0ae13acef7da22a275fb4dbf","modified":1687944856576},{"_id":"themes/maupassant/source/css/search.scss","hash":"a1720a63170ff4ae9048f634e8e1900e7a3cc45a","modified":1687944856576},{"_id":"themes/maupassant/source/css/copyright.scss","hash":"ad420043e1d0518bfbf3b2a2d87fb5b104587c6f","modified":1687944856576},{"_id":"themes/maupassant/source/img/avatar.png","hash":"2f701dadc2dc8eb637f48b5eedf9bca7fb5fd031","modified":1687944856580},{"_id":"themes/maupassant/source/css/style.scss","hash":"87728a8270ef74dcedc7dd5258aa4e2b1ddf05f2","modified":1687944856578},{"_id":"themes/maupassant/source/img/alipay.svg","hash":"3d94d2f9b09e352802628c9225578e1086f5fef3","modified":1687944856579},{"_id":"themes/maupassant/source/img/bitcoin.svg","hash":"590b6b6462896168d08b30dfe2de5f08950d5553","modified":1687944856581},{"_id":"themes/maupassant/source/img/github.svg","hash":"277798d16cb6106e45ef74f6b9972011fa43401b","modified":1687944856581},{"_id":"themes/maupassant/source/img/like.svg","hash":"e6e4bd1af076be9358316cac89efdc22ef4a5064","modified":1687944856582},{"_id":"themes/maupassant/source/img/paypal.svg","hash":"09786c983a10bc570dcd05b87cec601e9d01eb00","modified":1687944856583},{"_id":"themes/maupassant/source/js/codeblock-resizer.js","hash":"c77270e684a60babc1abb7353e700ecdc5a66d30","modified":1687944856585},{"_id":"themes/maupassant/source/img/wechat.svg","hash":"19c1f68ec8c0b8e9f7855e7a6e78077f70a1aedc","modified":1687944856584},{"_id":"themes/maupassant/source/js/copycode.js","hash":"6df3139581744e7bcd47243e4587f5397c2a24c3","modified":1687944856586},{"_id":"themes/maupassant/source/js/copyright.js","hash":"0e9a845ae05d2f00721ff6ee910c8c3cace26043","modified":1687944856586},{"_id":"themes/maupassant/source/js/donate.js","hash":"82f06bd69782c1138c98b4276771a41e3a54c061","modified":1687944856587},{"_id":"themes/maupassant/source/js/fancybox.js","hash":"cbfae8d963e8a84d8472093e57576de18af3b45b","modified":1687944856587},{"_id":"themes/maupassant/source/js/love.js","hash":"60df5dc3d09c8f33d1d02f54cbc73bf8d62f52fb","modified":1687944856587},{"_id":"themes/maupassant/source/js/recent-comments.js","hash":"b09acdd54126290268e1ab554433afa1d8f64aaf","modified":1687944856588},{"_id":"themes/maupassant/source/js/search.js","hash":"65d8e6d6c46fa060ce5b0d89e2fd778b6b2967d5","modified":1687944856589},{"_id":"themes/maupassant/source/js/share.js","hash":"514e726c1efae9f6566600fa0e945b4b9e620f2e","modified":1687944856589},{"_id":"themes/maupassant/source/js/smartresize.js","hash":"150ab1cad40d7ae081b0896b13f7d7cbac4e6338","modified":1687944856590},{"_id":"themes/maupassant/source/js/totop.js","hash":"15de186b089c245fe60766d509b587919f05ff23","modified":1687944856590},{"_id":"public/react/01-Describing-The-UI.html","hash":"91435e44a3a57d31eee8b38410e59d5da0203edd","modified":1687947363061},{"_id":"public/2023/03/03/sort-search/index.html","hash":"7d2820355a9565658fafc1134c562e1c46c58696","modified":1687947363061},{"_id":"public/2023/03/03/hooks/index.html","hash":"24e4f8fcde81793b12715c28ad6065f4a615c87d","modified":1687947363061},{"_id":"public/about/index.html","hash":"2f86068df8b002699898ea2f887db5d59c70e697","modified":1687947363061},{"_id":"public/2023/01/31/hexo-basic/index.html","hash":"ed43ccecf8c9761db3e4d1eabe9994f032c5a633","modified":1687947363061},{"_id":"public/archives/index.html","hash":"5031befb634abec0c3543d5e28e3fafb4f319629","modified":1687947363061},{"_id":"public/archives/2023/index.html","hash":"5031befb634abec0c3543d5e28e3fafb4f319629","modified":1687947363061},{"_id":"public/archives/2023/01/index.html","hash":"74274fada9a16788a9dff93c0422fe5ef5f91722","modified":1687947363061},{"_id":"public/archives/2023/03/index.html","hash":"9dacd6b1e9ce7406b5f10605fbcececd2dfe7999","modified":1687947363061},{"_id":"public/index.html","hash":"86eb000cafc3686397730d17c89cb119e6f2a482","modified":1687947363061},{"_id":"public/categories/工具/index.html","hash":"6ee3bf23d1c500801e75e8217bb7c897db90867d","modified":1687947363061},{"_id":"public/categories/前端/index.html","hash":"36c0de8a14cf3f78c497d56677e4bde9f5ead958","modified":1687947363061},{"_id":"public/tags/react/index.html","hash":"78974cd1bf108b5f3346df49e4003aa8bfad9c93","modified":1687947363061},{"_id":"public/tags/framework/index.html","hash":"1df52da24cb69c763a65741e7030fd07151f06d0","modified":1687947363061},{"_id":"public/tags/文档工具/index.html","hash":"7fc5ac3f976498e842fd711c7a46b148f4a0daf0","modified":1687947363061},{"_id":"public/tags/ES6/index.html","hash":"cdb8419750826037ade002b4e7080dc74e871389","modified":1687947363061},{"_id":"public/tags/Promise/index.html","hash":"5ae09e7552f8d938844ce8c6bbf4396ccc969e64","modified":1687947363061},{"_id":"public/tags/算法/index.html","hash":"a7dde347ebd85a0c12962cce4c30a40bb1ab2112","modified":1687947363061},{"_id":"public/2023/01/31/promise-detail/index.html","hash":"d45c272f4fa66a0c30ed6aaf2148ff8daa6a2f8f","modified":1687947363061},{"_id":"public/favicon.ico","hash":"98d04439770976a136c30243b25b28f6609b79b2","modified":1687947363061},{"_id":"public/img/avatar.png","hash":"2f701dadc2dc8eb637f48b5eedf9bca7fb5fd031","modified":1687947363061},{"_id":"public/img/alipay.svg","hash":"3d94d2f9b09e352802628c9225578e1086f5fef3","modified":1687947363061},{"_id":"public/img/bitcoin.svg","hash":"590b6b6462896168d08b30dfe2de5f08950d5553","modified":1687947363061},{"_id":"public/img/github.svg","hash":"277798d16cb6106e45ef74f6b9972011fa43401b","modified":1687947363061},{"_id":"public/img/like.svg","hash":"e6e4bd1af076be9358316cac89efdc22ef4a5064","modified":1687947363061},{"_id":"public/img/paypal.svg","hash":"09786c983a10bc570dcd05b87cec601e9d01eb00","modified":1687947363061},{"_id":"public/img/wechat.svg","hash":"19c1f68ec8c0b8e9f7855e7a6e78077f70a1aedc","modified":1687947363061},{"_id":"public/css/copycode.css","hash":"803d8bf898f47c3929665eb7af97da22f11efacd","modified":1687947363061},{"_id":"public/css/search.css","hash":"0d0f73b357c3bc5077ef657c73f679b22bea93fb","modified":1687947363061},{"_id":"public/css/donate.css","hash":"d631def20dfb661439c506f28dc791f331d506f8","modified":1687947363061},{"_id":"public/css/copyright.css","hash":"e857156bd1f971fe6abdc22d2b8c82e495387438","modified":1687947363061},{"_id":"public/js/copycode.js","hash":"fde1f153bab1f00ae8930668094c00aa9ff3c7a3","modified":1687947363061},{"_id":"public/js/codeblock-resizer.js","hash":"5d0b786d60bf225d9eabcc9cece2719ff4d9b6cd","modified":1687947363061},{"_id":"public/js/copyright.js","hash":"7b1bd775ea22abf33d57f78628f436bf656e439a","modified":1687947363061},{"_id":"public/js/donate.js","hash":"bdddd8d9847462d020f7a511e7e12c046223195d","modified":1687947363061},{"_id":"public/js/fancybox.js","hash":"cb195eb6177a2167f1f15c340272c1569c185b14","modified":1687947363061},{"_id":"public/js/recent-comments.js","hash":"78708f86aa1fdcc003a056b1f91aac62d31bb012","modified":1687947363061},{"_id":"public/js/search.js","hash":"6fdfd143646d12b8dbef9b5809cea768192f08aa","modified":1687947363061},{"_id":"public/js/share.js","hash":"a2f9de374523dc7f2ddb90ed5f24b668c20d9272","modified":1687947363061},{"_id":"public/js/love.js","hash":"5cf89f622bf891cf1986845eb92eadef6f358eb7","modified":1687947363061},{"_id":"public/js/smartresize.js","hash":"3ef157fd877167e3290f42c67a624ea375a46c24","modified":1687947363061},{"_id":"public/js/totop.js","hash":"7dbf8fcf582a4fb6eb9b2c60d6de9f9c2091ec4c","modified":1687947363061},{"_id":"public/css/style.css","hash":"19b76fd441e5b19e47cb4ecf871b202607c9bdaa","modified":1687947363061},{"_id":"source/UI-描述/index.md","hash":"08cdc32aae6bc327db8eda4d5c64891a55781d44","modified":1687947518264},{"_id":"source/01-Describing-The-UI/index.md","hash":"08cdc32aae6bc327db8eda4d5c64891a55781d44","modified":1687947596188},{"_id":"source/_posts/01-Describing-The-UI.md","hash":"216279c250055efe3073d07e658b7aca8d8e2027","modified":1687950041833},{"_id":"source/_posts/02-Adding-Interactivity.md","hash":"f312d1232577902c4eeb1d98affe25d3045a6d56","modified":1687950052705}],"Category":[{"name":"工具","_id":"cljfka1kk0006dcv49rmw54ns"},{"name":"前端","_id":"cljfka1kn0009dcv40mbq6aoa"},{"name":"Framework","_id":"cljflv4jr000amsv4b16s7zxv"}],"Data":[],"Page":[],"Post":[{"title":"hooks 详解","date":"2023-03-03T06:43:30.000Z","_content":"\n## Hooks 的使用\n\n## Hooks 的规则\n\n## 自定义 Hooks\n\n## Hooks 实现\n","source":"_posts/hooks.md","raw":"---\n#layout: page\ntitle: hooks 详解\ndate: 2023-03-03 14:43:30\ntags: [react, framework]\n---\n\n## Hooks 的使用\n\n## Hooks 的规则\n\n## 自定义 Hooks\n\n## Hooks 实现\n","slug":"hooks","published":1,"updated":"2023-06-28T09:32:50.977Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljfka1k70001dcv4fjcld5o2","content":"<h2 id=\"Hooks-的使用\"><a href=\"#Hooks-的使用\" class=\"headerlink\" title=\"Hooks 的使用\"></a>Hooks 的使用</h2><h2 id=\"Hooks-的规则\"><a href=\"#Hooks-的规则\" class=\"headerlink\" title=\"Hooks 的规则\"></a>Hooks 的规则</h2><h2 id=\"自定义-Hooks\"><a href=\"#自定义-Hooks\" class=\"headerlink\" title=\"自定义 Hooks\"></a>自定义 Hooks</h2><h2 id=\"Hooks-实现\"><a href=\"#Hooks-实现\" class=\"headerlink\" title=\"Hooks 实现\"></a>Hooks 实现</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Hooks-的使用\"><a href=\"#Hooks-的使用\" class=\"headerlink\" title=\"Hooks 的使用\"></a>Hooks 的使用</h2><h2 id=\"Hooks-的规则\"><a href=\"#Hooks-的规则\" class=\"headerlink\" title=\"Hooks 的规则\"></a>Hooks 的规则</h2><h2 id=\"自定义-Hooks\"><a href=\"#自定义-Hooks\" class=\"headerlink\" title=\"自定义 Hooks\"></a>自定义 Hooks</h2><h2 id=\"Hooks-实现\"><a href=\"#Hooks-实现\" class=\"headerlink\" title=\"Hooks 实现\"></a>Hooks 实现</h2>"},{"title":"关于","date":"2023-01-31T04:16:06.000Z","_content":"\n## 关于我 (hanbin)\n\n### 教育背景：\n\n2015.9 - 2019.6 武汉工程大学 物联网工程\n\n### 主要工作经历：\n\n2018.9-2019.1 用友金融科技股份有限公司 Java 实习岗\n2019.4-2021.7 烽火通信科技股份有限公司 前端开发岗【Angular 2+】\n2021.8-至今 青藤云 前端开发岗\n\n### 兴趣爱好：\n\n刷剧追番、逛 b 站\n跑步、乒乓球、羽毛球【技术菜】\n看书、看公众号、看博客、逛知乎\n喜欢技术，无奈技术菜【人菜求人带】\n\n### 电子邮件:\n\nhanbin_che@163.com\n","source":"_posts/about.md","raw":"---\ntitle: 关于\ndate: 2023-01-31 12:16:06\ntags:\npermalink: /about/\n---\n\n## 关于我 (hanbin)\n\n### 教育背景：\n\n2015.9 - 2019.6 武汉工程大学 物联网工程\n\n### 主要工作经历：\n\n2018.9-2019.1 用友金融科技股份有限公司 Java 实习岗\n2019.4-2021.7 烽火通信科技股份有限公司 前端开发岗【Angular 2+】\n2021.8-至今 青藤云 前端开发岗\n\n### 兴趣爱好：\n\n刷剧追番、逛 b 站\n跑步、乒乓球、羽毛球【技术菜】\n看书、看公众号、看博客、逛知乎\n喜欢技术，无奈技术菜【人菜求人带】\n\n### 电子邮件:\n\nhanbin_che@163.com\n","slug":"about","published":1,"updated":"2023-06-28T09:32:50.977Z","__permalink":"/about/","comments":1,"layout":"post","photos":[],"link":"","_id":"cljfka1ka0002dcv4b3wcd3wj","content":"<h2 id=\"关于我-hanbin\"><a href=\"#关于我-hanbin\" class=\"headerlink\" title=\"关于我 (hanbin)\"></a>关于我 (hanbin)</h2><h3 id=\"教育背景：\"><a href=\"#教育背景：\" class=\"headerlink\" title=\"教育背景：\"></a>教育背景：</h3><p>2015.9 - 2019.6 武汉工程大学 物联网工程</p>\n<h3 id=\"主要工作经历：\"><a href=\"#主要工作经历：\" class=\"headerlink\" title=\"主要工作经历：\"></a>主要工作经历：</h3><p>2018.9-2019.1 用友金融科技股份有限公司 Java 实习岗<br>2019.4-2021.7 烽火通信科技股份有限公司 前端开发岗【Angular 2+】<br>2021.8-至今 青藤云 前端开发岗</p>\n<h3 id=\"兴趣爱好：\"><a href=\"#兴趣爱好：\" class=\"headerlink\" title=\"兴趣爱好：\"></a>兴趣爱好：</h3><p>刷剧追番、逛 b 站<br>跑步、乒乓球、羽毛球【技术菜】<br>看书、看公众号、看博客、逛知乎<br>喜欢技术，无奈技术菜【人菜求人带】</p>\n<h3 id=\"电子邮件\"><a href=\"#电子邮件\" class=\"headerlink\" title=\"电子邮件:\"></a>电子邮件:</h3><p><a href=\"mailto:&#104;&#x61;&#x6e;&#x62;&#x69;&#x6e;&#x5f;&#99;&#104;&#x65;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;\">&#104;&#x61;&#x6e;&#x62;&#x69;&#x6e;&#x5f;&#99;&#104;&#x65;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"关于我-hanbin\"><a href=\"#关于我-hanbin\" class=\"headerlink\" title=\"关于我 (hanbin)\"></a>关于我 (hanbin)</h2><h3 id=\"教育背景：\"><a href=\"#教育背景：\" class=\"headerlink\" title=\"教育背景：\"></a>教育背景：</h3><p>2015.9 - 2019.6 武汉工程大学 物联网工程</p>\n<h3 id=\"主要工作经历：\"><a href=\"#主要工作经历：\" class=\"headerlink\" title=\"主要工作经历：\"></a>主要工作经历：</h3><p>2018.9-2019.1 用友金融科技股份有限公司 Java 实习岗<br>2019.4-2021.7 烽火通信科技股份有限公司 前端开发岗【Angular 2+】<br>2021.8-至今 青藤云 前端开发岗</p>\n<h3 id=\"兴趣爱好：\"><a href=\"#兴趣爱好：\" class=\"headerlink\" title=\"兴趣爱好：\"></a>兴趣爱好：</h3><p>刷剧追番、逛 b 站<br>跑步、乒乓球、羽毛球【技术菜】<br>看书、看公众号、看博客、逛知乎<br>喜欢技术，无奈技术菜【人菜求人带】</p>\n<h3 id=\"电子邮件\"><a href=\"#电子邮件\" class=\"headerlink\" title=\"电子邮件:\"></a>电子邮件:</h3><p><a href=\"mailto:&#104;&#x61;&#x6e;&#x62;&#x69;&#x6e;&#x5f;&#99;&#104;&#x65;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;\">&#104;&#x61;&#x6e;&#x62;&#x69;&#x6e;&#x5f;&#99;&#104;&#x65;&#x40;&#x31;&#54;&#x33;&#x2e;&#99;&#x6f;&#109;</a></p>\n"},{"title":"Hexo快速入门","date":"2023-01-30T16:00:00.000Z","comments":1,"_content":"\n## 快速开始\n\n### 生成一个新的文章\n\n```bash\n$ hexo new \"My New Post\"\n```\n\n详细用法请参考: [Writing](https://hexo.io/docs/writing.html)\n\n### 运行 Hexo 服务\n\n```bash\n$ hexo server\n```\n\n详细用法请参考: [Server](https://hexo.io/docs/server.html)\n\n### 生成静态文件\n\n```bash\n$ hexo generate\n```\n\n详细用法请参考: [Generating](https://hexo.io/docs/generating.html)\n\n### 部署到远程网站\n\n```bash\n$ hexo deploy\n```\n\n详细用法请参考: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hexo-basic.md","raw":"---\n# layout: # 布局，默认使用config.default._layout\ntitle: Hexo快速入门 # 文章的文件名\ndate: 2023-01-31 # 文件创建日期\ncomments: true # 开启文章的评论功能\ntags: # 标签\n  - 文档工具\ncategories: 工具 # 分类\n# permalink:  # 覆盖文章的永久链接，永久链接应该以 / 或者 .html 结尾\n---\n\n## 快速开始\n\n### 生成一个新的文章\n\n```bash\n$ hexo new \"My New Post\"\n```\n\n详细用法请参考: [Writing](https://hexo.io/docs/writing.html)\n\n### 运行 Hexo 服务\n\n```bash\n$ hexo server\n```\n\n详细用法请参考: [Server](https://hexo.io/docs/server.html)\n\n### 生成静态文件\n\n```bash\n$ hexo generate\n```\n\n详细用法请参考: [Generating](https://hexo.io/docs/generating.html)\n\n### 部署到远程网站\n\n```bash\n$ hexo deploy\n```\n\n详细用法请参考: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hexo-basic","published":1,"updated":"2023-06-28T09:32:50.977Z","layout":"post","photos":[],"link":"","_id":"cljfka1kd0004dcv4bl8s090e","content":"<h2 id=\"快速开始\"><a href=\"#快速开始\" class=\"headerlink\" title=\"快速开始\"></a>快速开始</h2><h3 id=\"生成一个新的文章\"><a href=\"#生成一个新的文章\" class=\"headerlink\" title=\"生成一个新的文章\"></a>生成一个新的文章</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"运行-Hexo-服务\"><a href=\"#运行-Hexo-服务\" class=\"headerlink\" title=\"运行 Hexo 服务\"></a>运行 Hexo 服务</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"生成静态文件\"><a href=\"#生成静态文件\" class=\"headerlink\" title=\"生成静态文件\"></a>生成静态文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"部署到远程网站\"><a href=\"#部署到远程网站\" class=\"headerlink\" title=\"部署到远程网站\"></a>部署到远程网站</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"快速开始\"><a href=\"#快速开始\" class=\"headerlink\" title=\"快速开始\"></a>快速开始</h2><h3 id=\"生成一个新的文章\"><a href=\"#生成一个新的文章\" class=\"headerlink\" title=\"生成一个新的文章\"></a>生成一个新的文章</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"运行-Hexo-服务\"><a href=\"#运行-Hexo-服务\" class=\"headerlink\" title=\"运行 Hexo 服务\"></a>运行 Hexo 服务</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"生成静态文件\"><a href=\"#生成静态文件\" class=\"headerlink\" title=\"生成静态文件\"></a>生成静态文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"部署到远程网站\"><a href=\"#部署到远程网站\" class=\"headerlink\" title=\"部署到远程网站\"></a>部署到远程网站</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>详细用法请参考: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"},{"title":"Promise详解","date":"2023-01-31T03:46:20.000Z","toc":true,"_content":"\n## 前言\n\nPromise 是 ES6 异步编程的核心，很多库的异步都从回调向 Promise 转变，Promise 在前端领域发挥着越来越重要的作用；掌握 Promise 的正确使用、理解 Promise 的实现成为了现代前端开发者不可或缺的技能。\n\n<!--\n### Promise 是什么\n\n### Promise 如何使用\n\n### Promise 什么场景|时候使用\n-->\n\n## Promise 的核心原理实现\n\n首先我们从 Promise 的定义和使用方式开始分析 Promise。\n\n### Promise 的使用分析\n\nPromise 是一个类，在执行这个类的时候，需要传递一个执行器参数，执行器会立即执行。\n\n#### Promise 的三个状态\n\n- pending → 等待\n- fulfilled → 成功\n- rejected → 失败\n\n#### 状态切换\n\n- pending → fulfilled\n- pending → rejected\n\n#### 一旦状态发生改变，状态将不可变\n\n- 执行器中的两个参数，分别是 resolve 和 reject，其实就是两个回调函数，调用 resolve 是从 pending 状态转变为 fulfilled 状态，调用 reject 是从 pending 状态转变为 rejected 状态。传递给这两个回调函数的参数会作为成功或失败的值。\n- Promise 实例对象具有一个 then 方法，该方法接受两个回调函数，分别来处理成功与失败的状态，then 方法内部会进行判断，然后根据当前的状态调用对应的回调函数。then 方法应该是被定义在原型对象中的。\n- then 的回调函数中都包含一个值，如果是成功，表示成功后返回的值；如果是失败，就表示失败的原因。\n\n### MyPromise 的实现\n\n根据上述分析，我们可以给出如下实现：\n\n```js\n// 所有状态\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n// Promise 本质上是一个类\nclass MyPromise {\n  constructor(executor) {\n    // 实例化Promise时需要一个执行器回调，该回调立即执行\n    executor(this.resolve, this.reject);\n  }\n\n  //   Promise 的初始状态;\n  status = PENDING;\n  // 记录成功与失败的值\n  value = undefined;\n  reason = undefined;\n\n  // 此处使用箭头函数为了解决resolve调用中this的指向问题\n  resolve = (value) => {\n    // 如果状态不是 PENDING 直接跳出该逻辑\n    if (this.status !== PENDING) return;\n    // 将状态修改为 成功\n    this.status = FULFILLED;\n\n    // 将 resolve 回调的参数进行保存\n    this.value = value;\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) return;\n\n    // 将状态修改为失败\n    this.status = REJECTED;\n\n    // 保存失败的原因\n    this.reason = reason;\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // 根据当前状态指定回调\n    if (this.status === FULFILLED) {\n      // 将成功的值作为回调函数的参数返回\n      onFulfilled(this.value);\n    } else if (this.status === REJECTED) {\n      // 将失败的值作为回调函数的参数返回\n      onRejected(this.reason);\n    }\n  };\n}\n```\n\n接下来我们给出一段验证代码：\n\n**验证 resolve**\n\n```js\nconst MyPromise = require('./my-promise');\n\nconst promise = new MyPromise((resolve, reject) => {\n  resolve('Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\n// Hello Promise Resolve~\n```\n\n**验证 reject**\n\n```js\nconst MyPromise = require('./my-promise');\n\nconst promise = new MyPromise((resolve, reject) => {\n  reject('Hello Promise Reject~');\n});\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\n// Hello Promise Reject~\n```\n\n**验证状态不可变**\n\n```js\nconst MyPromise = require('./my-promise');\n\nconst promise = new MyPromise((resolve, reject) => {\n  resolve('Hello Promise Resolve~');\n  reject('Hello Promise Reject~');\n});\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\n// Hello Promise Resolve~\n```\n\n**测试异步**\n\n上述简易版 Promise 中如果存在异步操作将无法正确处理\n\n```js\nconst MyPromise = require('./my-promise');\nconst promise = new MyPromise((resole, reject) => {\n  setTimeout(resolve, 2000, 'Hello Promise Resolve~');\n});\n\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n```\n\n上述代码将不会有任何输出\n\n**原因分析**\n\n- MyPromise 的实现中没有考虑异步的实现，在异步函数中修改 Promise 的状态后没有调用 then 回调\n- then 回调先于 resolve/reject 执行，此时 Promise 的状态还处于 PENDING，将不会执行任何操作[MyPromise 中未对该阶段进行处理]\n\n### 在 Promise 中加入异步操作\n\n根据 `原因分析` 给出如下解决办法：\n\n1. 创建 `onFulfilled` 和 `onRejected` 两个属性用来存储 then 中的回调\n2. 为 `then` 方法添加状态为 `PENDING` 的处理逻辑，及时将 onFulfilled 和 onRejected 回调进行存储，便于在异步方法中调用 resolve/reject 变更状态时及时触发对应的 then 中的回调\n3. 在成功或失败时及时调用对应的 onFulfilled 或者 onRejected 回调\n\n增加异步操作的 Promise 实现如下：\n\n```js\nclass MyPromise {\n  constructor(executor) {\n    // 实例化Promise时需要一个执行器回调，该回调立即执行\n    executor(this.resolve, this.reject);\n  }\n\n  //   Promise 的初始状态;\n  status = PENDING;\n  // 记录成功与失败的值\n  value = undefined;\n  reason = undefined;\n\n  // then中的onFulfilled和onRejected回调\n  onFulfilled = undefined;\n  onRejected = undefined;\n\n  // 此处使用箭头函数为了解决resolve调用中this的指向问题\n  resolve = (value) => {\n    // 如果状态不是 PENDING 直接跳出该逻辑\n    if (this.status !== PENDING) return;\n    // 将状态修改为 成功\n    this.status = FULFILLED;\n\n    // 将 resolve 回调的参数进行保存\n    this.value = value;\n\n    // 如果状态变更为 成功，调用成功的回调\n    this.onFulfilled && this.onFulfilled(this.value);\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) return;\n\n    // 将状态修改为失败\n    this.status = REJECTED;\n\n    // 保存失败的原因\n    this.reason = reason;\n\n    // 如果状态变更为 失败，调用失败的回调\n    this.onRejected && this.onRejected(this.reason);\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // 根据当前状态指定回调\n    if (this.status === FULFILLED) {\n      // 将成功的值作为回调函数的参数返回\n      onFulfilled(this.value);\n    } else if (this.status === REJECTED) {\n      // 将失败的值作为回调函数的参数返回\n      onRejected(this.reason);\n    } else {\n      // 既不是成功也不是失败。这个时候保存传递进来的两个回调，便于 异步操作中 更新 Promise 状态时，触发对应的回调\n      this.onFulfilled = onFulfilled;\n      this.onRejected = onRejected;\n    }\n  };\n}\n```\n\n**验证多次 then 调用**\n\n```js\nconst promise = new MyPromise((resolve) => {\n  setTimeout(resolve, 2000, 'Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value + ' first.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    console.log(value + ' second.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    setTimeout(() => {\n      console.log(value + ' third.');\n    }, 1000);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n// 3s后输出： Hello Promise Resolve~ third.\n```\n\n**原因分析**\n\n如果执行器中存在**异步逻辑**，`then 函数又先于 异步逻辑 执行`，导致多次 `then` 调用存在覆盖 bug，即在后面的 then 调用会覆盖前面的 `then` 回调\n\n### 实现 then 方法的多次调用\n\n根据 `原因分析` 给出如下解决方案：\n\n1. 将保存 `then` 回调的 onFulfilled 和 onRejected 属性改为数组形式，便于存储多个 `then` 回调.\n\n增加存储多次 then 回调的实现如下：\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    executor(this.resolve, this.reject);\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    if (this.status === FULFILLED) {\n      onFulfilled(this.value);\n    }\n\n    if (this.status === REJECTED) {\n      onRejected(this.reason);\n    }\n\n    if (this.status === PENDING) {\n      // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n      this.onFulfilled.push(onFulfilled);\n      this.onRejected.push(onRejected);\n    }\n  };\n}\n```\n\n**验证多次 then 调用**\n\n```js\nconst promise = new MyPromise((resolve) => {\n  resolve('Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value + ' first.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    console.log(value + ' second.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    setTimeout(() => {\n      console.log(value + ' third.');\n    }, 1000);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n// 输出\n// 立即输出：\n// Hello Promise Resolve~ first.\n// Hello Promise Resolve~ second.\n// 1s后输出\n// Hello Promise Resolve~ third.\n\nconst promise = new MyPromise((resolve) => {\n  setTimeout(resolve, 2000, 'Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value + ' first.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    console.log(value + ' second.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    setTimeout(() => {\n      console.log(value + ' third.');\n    }, 1000);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n// 输出\n// 2s后输出：\n// Hello Promise Resolve~ first.\n// Hello Promise Resolve~ second.\n// 3s后输出\n// Hello Promise Resolve~ third.\n```\n\n### <text style=\"color: red;\">实现 then 方法的链式调用[难点]</text>\n\n**要想实现 then 的链式调用，主要需要解决两个问题：**\n\n1. 返回的是一个新的 `MyPromise` 的实例；\n2. `then` 的返回值作为下一次的链式调用的参数。\n\n**这里分为两种情况：**\n\n1. 直接返回一个值，可以直接作为值使用；\n2. 返回一个新的 `MyPromise` 实例，此时就需要判断其状态；\n\n**代码实现**：\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    executor(this.resolve, this.reject);\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // then 方法返回一个 MyPromise 实例\n    return new MyPromise((resolve, reject) => {\n      if (this.status === FULFILLED) {\n        const result = onFulfilled(this.value);\n\n        // 如果result是一个普通值，直接resolve(result)\n        // 如果是一个 MyPromise 实例，根据返回的解决来决定时调用 resolve 还是 reject\n        resolvePromise(result, resolve, reject);\n      }\n\n      if (this.status === REJECTED) {\n        onRejected(this.reason);\n      }\n\n      if (this.status === PENDING) {\n        // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n        this.onFulfilled.push(onFulfilled);\n        this.onRejected.push(onRejected);\n      }\n    });\n  };\n}\n\nfunction resolvePromise(result, resolve, reject) {\n  if (result instanceof MyPromise) {\n    result.then(resolve, reject);\n  } else {\n    resolve(result);\n  }\n}\n```\n\n**验证链式调用**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  resolve('Hello Promise Resolve~');\n});\nconst promise2 = promise1.then(\n  (value) => {\n    console.log(value + ' promise1.');\n    // 当前 Promise 的 resolve 回调函数的返回值将作为下一个链式调用的 then 中的 onFulfilled 回调函数的参数值\n    return 'Hello Promise2 Resolve~';\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\npromise2.then(\n  // 此处的 value 即为 'Hello Promise2 Resolve~'\n  (value) => {\n    console.log(value + ` promise2.`);\n  },\n  (reason) => {\n    console.log(reason + ` promise2.`);\n  }\n);\n\n// 输出：\n// Hello Promise Resolve~ promise1.\n// Hello Promise2 Resolve~ promise2.\n```\n\n### then 方法链式调用识别 Promise 对象自返回 [难点]\n\n在 Promise 中，如果 `then` 方法返回的是自己的 `Promise` 对象，则会发生 `Promise` 的嵌套，这个时候程序会报错。\n\n**测试代码**\n\n```js\nconst p1 = new Promise((resolve, reject) => {\n  resolve(12);\n});\nconst p2 = p1.then((v) => {\n  console.log(v);\n  return p2;\n});\np2.then((v) => console.log(v));\n\n// 输出：\n// 12\n// Promise {<rejected>: TypeError: Chaining cycle detected for promise #<Promise>}\n// Uncaught (in promise) TypeError: Chaining cycle detected for promise #<Promise>\n```\n\n**解决办法**\n\n只需判断 `then` 返回的 Promise 实例与 then 中回调函数返回的实例是否是同一个即可，如果是引用的同一个实例，那么就抛出错误\n\n**实现代码**\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    executor(this.resolve, this.reject);\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // then 方法返回一个 MyPromise 实例\n    const promise = new MyPromise((resolve, reject) => {\n      if (this.status === FULFILLED) {\n        // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n        setTimeout(() => {\n          const result = onFulfilled(this.value);\n\n          resolvePromise(promise, result, resolve, reject);\n        }, 0);\n      }\n\n      if (this.status === REJECTED) {\n        onRejected(this.reason);\n      }\n\n      if (this.status === PENDING) {\n        // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n        this.onFulfilled.push(onFulfilled);\n        this.onRejected.push(onRejected);\n      }\n    });\n\n    return promise;\n  };\n}\n\nfunction resolvePromise(promise, result, resolve, reject) {\n  // 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常\n  if (promise === result) {\n    // 这里调用reject，并抛出一个Error\n    // return 是必须的，阻止程序向下执行\n    return reject(\n      new TypeError('Chaining cycle detected for promise #<Promise>')\n    );\n  } else {\n    // 判断 result 是不是 MyPromise 实例\n    if (result instanceof MyPromise) {\n      // 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject\n      result.then(resolve, reject);\n    } else {\n      resolve(result);\n    }\n  }\n}\n```\n\n> 这里 then 方法中的 setTimeout 的作用并不是延迟执行，而是为了调用 resolvePromise 函数时，保证创建的 promise 存在。\n\n**验证代码**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  resolve('Hello Promise Resolve~');\n});\nconst promise2 = promise1.then(\n  (value) => {\n    console.log(value + ' promise1.');\n    return promise2;\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\npromise2.then(\n  (value) => {\n    console.log(value + ` promise2.`);\n  },\n  (reason) => {\n    console.log(reason + ` promise2.`);\n  }\n);\n// 输出：\n// Hello Promise Resolve~ promise1.\n// TypeError: Chaining cycle detected for promise #<Promise> promise2.\n```\n\n## 捕捉错误及 then 链式调用其他状态代码补充\n\n到目前为止我们实现的 Promise 并没有对异常做任何处理，为了保证代码的健壮性，我们需要对异常做一些处理。\n\n### 捕捉执行器报错\n\n如果执行器函数在执行过程中发生了异常，需要捕获异常并且在捕获逻辑中调用 reject 将异常传出去\n\n**关键实现代码**\n\n```js\nconstructor(executor) {\n  try {\n    executor(this.resolve, this.reject);\n  } catch (error) {\n    this.reject(error);\n  }\n}\n```\n\n**测试代码**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  throw new Error('执行器异常');\n});\npromise1.then(console.log, console.log);\n\n// 输出：\n// Error: 执行器异常\n//     at E:\\blog\\source\\_posts\\my-promise.js:100:11\n//     at new MyPromise (E:\\blog\\source\\_posts\\my-promise.js:14:13)\n//     at Object.<anonymous> (E:\\blog\\source\\_posts\\my-promise.js:99:18)\n//     at Module._compile (node:internal/modules/cjs/loader:1126:14)\n//     at Object.Module._extensions..js (node:internal/modules/cjs/loader:1180:10)\n//     at Module.load (node:internal/modules/cjs/loader:1004:32)\n//     at Function.Module._load (node:internal/modules/cjs/loader:839:12)\n//     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)\n//     at node:internal/main/run_main_module:17:47\n```\n\n### 捕捉 then 中的报错\n\n如果需要捕获 `then` 中的异常，与执行器中同理，需要在 then 中将捕获到的异常通过 reject 传递出去，异常需要通过 `try...catch` 捕获。\n\n**关键实现代码**\n\n```js\nthen = (onFulfilled, onRejected) => {\n  // then 方法返回一个 MyPromise 实例\n  const promise = new MyPromise((resolve, reject) => {\n    if (this.status === FULFILLED) {\n      // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n      setTimeout(() => {\n        try {\n          // 将成功的值作为参数返回\n          // 保存执行回调函数的结果\n          const result = onFulfilled(this.value);\n\n          // 如果返回的是一个普通的值，直接调用resolve\n          // 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject\n          resolvePromise(promise, result, resolve, reject);\n        } catch (error) {\n          reject(error);\n        }\n      }, 0);\n    }\n\n    // 将失败的原因作为参数返回\n    if (this.status === REJECTED) {\n      onRejected(this.reason);\n    }\n\n    if (this.status === PENDING) {\n      // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n      this.onFulfilled.push(onFulfilled);\n      this.onRejected.push(onRejected);\n    }\n  });\n\n  return promise;\n};\n```\n\n**测试代码**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  resolve(Math.PI);\n});\npromise1\n  .then((pi) => console.log(2 * pi * r), console.log)\n  .then(console.log, console.log);\n\n// 输出：\n// ReferenceError: r is not defined\n//     at E:\\blog\\source\\_posts\\my-promise.js:112:40\n//     at Timeout._onTimeout (E:\\blog\\source\\_posts\\my-promise.js:64:40)\n//     at listOnTimeout (node:internal/timers:559:17)\n//     at processTimers (node:internal/timers:502:7)\n```\n\n### 错误与异步状态的链式调用\n\n目前只对成功状态的 then 进行了链式调用以及错误处理，错误与异步状态未进行处理，参照成功状态下的错误处理进行实现\n\n**关键实现代码**\n\n```js\nthen = (onFulfilled, onRejected) => {\n  // then 方法返回一个 MyPromise 实例\n  const promise = new MyPromise((resolve, reject) => {\n    if (this.status === FULFILLED) {\n      // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n      setTimeout(() => {\n        try {\n          // 将成功的值作为参数返回\n          // 保存执行回调函数的结果\n          const result = onFulfilled(this.value);\n\n          // 如果返回的是一个普通的值，直接调用resolve\n          // 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject\n          resolvePromise(promise, result, resolve, reject);\n        } catch (error) {\n          reject(error);\n        }\n      }, 0);\n    }\n\n    // 将失败的原因作为参数返回\n    if (this.status === REJECTED) {\n      // 失败的处理同成功处理，只是调用的回调函数不同\n      setTimeout(() => {\n        try {\n          const result = onRejected(this.reason);\n          resolvePromise(promise, result, resolve, reject);\n        } catch (error) {\n          reject(error);\n        }\n      }, 0);\n    }\n\n    if (this.status === PENDING) {\n      // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n      this.onFulfilled.push((value) => {\n        setTimeout(() => {\n          try {\n            const result = onFulfilled(value);\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      });\n      this.onRejected.push((reason) => {\n        setTimeout(() => {\n          try {\n            const result = onRejected(reason);\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      });\n    }\n  });\n\n  return promise;\n};\n```\n\n**测试代码**\n\n```js\nconst MyPromise = require('./myPromise');\nlet promise = new MyPromise((resolve, reject) => {\n  setTimeout(resolve, 2000, '成功');\n});\n// 第一个then方法中的错误要在第二个then方法中捕获到\npromise\n  .then((value) => {\n    console.log('resolve', value);\n    throw new Error('then的执行过程中遇到异常');\n  })\n  .then(null, (reason) => {\n    console.log(reason.message);\n  });\n/* 输出\n    resolve 成功\n    then的执行过程中遇到异常\n*/\n```\n\n## 将 then 方法的参数变成可选参数\n\nPromise 中的 then 方法其实是两个*可选参数*，如果我们不传递任何参数的话，里面的结果是向下传递的，直到捕获为止。\n\n**示例代码**\n\n```js\nnew Promise((resolve, reject) => {\n  resolve(100);\n})\n  .then()\n  .then()\n  .then()\n  .then((value) => console.log(value));\n// 最后一个then输入100\n```\n\n**这段代码可以理解为**\n\n```js\nnew Promise((resolve, reject) => {\n  resolve(100);\n})\n  .then((value) => value)\n  .then((value) => value)\n  .then((value) => value)\n  .then((value) => console.log(value));\n```\n\n**关键实现**\n\n```js\n// then方法的实现\nthen (onFulfilled, onRejected) {\n    // 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递\n    onFulfilled = onFulfilled ? onFulfilled : value => value\n    // 同理\n    onRejected = onRejected ? onRejected : reason => { throw reason }\n    // then 方法返回一个MyPromise实例\n    const promise = new MyPromise((resolve, reject) => {\n        // 判断当前状态,根据状态调用指定回调\n        if (this.status === FULFILLED) {...\n        } else if (this.status === REJECTED) {...\n        } else {...\n        }\n    })\n    return promise\n}\n```\n\n## Promise.all 方法的实现\n\n简单的说 `Promise.all()` 会将多个 Promise 实例包装为一个 Promise 实例，且顺序与调用顺序一致:\n**示例代码**\n\n```js\nfunction p1() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p1');\n    }, 2000);\n  });\n}\nfunction p2() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p2');\n    }, 0);\n  });\n}\nPromise.all(['a', 'b', p1(), p2(), 'c']).then((result) => {\n  console.log(result);\n  // [\"a\", \"b\", \"p1\", \"p2\", \"c\"]\n});\n```\n\n在这段代码中，我们的 p1 的执行是延迟了 2s 的，这里如果不使用 Promise.all()的话最终顺序是与我们调用不同的。\n\n**分析 Promise.all 的实现思路**\n\n- `all()` 方法是通过类直接调用的，所以是一个静态方法\n- `all()` 方法接收一个数组，数组中的值可以是一个普通值，也可以是一个 MyPromise 实例\n- return 一个新的 MyPromise 实例\n- 遍历数组中的每一个值，判断值的类型，如果是一个普通值就直接将值存入一个结果数组；如果是一个 MyPromise 实例对象，会调用其 then 方法，然后根据执行后的状态，如果失败的话调用 MyPromise 的 reject 方法，如果成功的话将值存入结果数组；\n- 存入数组时计数，如果存入的数量达到传入的数组长度，说明调用完毕，执行 `resolve` 并将最终的结果数组作为参数返回。\n\n**关键实现**\n\n```js\nMyPromise.all = (array) => {\n  // 用于存放最终结果的数组\n  let result = [];\n  // 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置\n  let count = 0;\n\n  // 返回一个 MyPromise 实例\n  return new MyPromise((resolve, reject) => {\n    function addResult(result, index, value, resolve) {\n      // 根据索引值，将结果推入数组中\n      result[index] = value;\n\n      // 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了\n      if (++count === array.length) {\n        // 将执行结果返回\n        resolve(result);\n      }\n    }\n\n    // 遍历传入的数组\n    array.forEach((item, index) => {\n      // 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中\n      if (item instanceof MyPromise) {\n        item.then(\n          (value) => {\n            addResult(result, index, value, resolve);\n          },\n          // 如果失败直接返回失败原因\n          (reason) => {\n            reject(reason);\n          }\n        );\n      } else {\n        addResult(result, index, item, resolve);\n      }\n    });\n  });\n};\n```\n\n**测试示例**\n\n```js\nfunction p1() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p1');\n    }, 2000);\n  });\n}\nfunction p2() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p2');\n    }, 0);\n  });\n}\nMyPromise.all(['a', 'b', p1(), p2(), 'c']).then((result) => {\n  console.log(result);\n  // [\"a\", \"b\", \"p1\", \"p2\", \"c\"]\n});\n```\n\n## Promise.resolve 方法的实现\n\n关于 Promise.resolve()方法的用法可以参考 Promise.resolve()与 Promise.reject()。\n**直线思路分析**\n\n- 该方法是一个静态方法\n- 该方法接收的如果是一个值就直接将该值包装为一个 MyPromise 实例对象返回,如果是一个 MyPromise 实例对象,则直接返回\n\n**关键实现**\n\n```js\nMyPromise.resolve = (value) => {\n  // 如果是MyPromise的实例，就直接返回这个实例\n  if (value instanceof MyPromise) {\n    return value;\n  } else {\n    // 如果不是的话创建一个MyPromise实例，并返回传递的值\n    return new MyPromise((resolve) => resolve(value));\n  }\n};\n```\n\n**测试代码**\n\n```js\nfunction p1() {\n  return new MyPromise((resolve, reject) => {\n    reject('p1');\n  });\n}\nfunction p2() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p2');\n    }, 2000);\n  });\n}\nMyPromise.resolve(p1()).then(console.log, console.log);\nMyPromise.resolve(3.1415926).then(console.log);\nMyPromise.resolve(p2()).then(console.log, console.log);\n// 输出\n// p1\n// 3.1415926\n// 2s后输出\n// p2\n```\n\n## finally 方法的实现\n\n**实现思路分析**\n\n- 不管 Promise 是 Fulfilled 还是 Rejected 状态,都会调用 finally 函数中的回调参数\n- 返回一个新的 Promise 实例\n\n**关键实现**\n\n```js\nfinally(callback) {\n    return this.then(\n        value => new MyPromise.resolve(callback()).then(() => value),\n        reason => new MyPromise.resolve(callback()).then(() => { throw reason })\n    );\n}\n```\n\n**测试代码**\n\n```js\nfunction p1() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p1');\n    }, 2000);\n  });\n}\nfunction p2() {\n  return new MyPromise((resolve, reject) => {\n    reject('p2 reject');\n  });\n}\np2()\n  .finally(() => {\n    console.log('finally p2');\n    return p1();\n  })\n  .then(\n    (value) => {\n      console.log(value);\n    },\n    (reason) => {\n      console.log(reason);\n    }\n  );\n// finally p2\n// 两秒之后执行p2 reject\n```\n\n## catch 方法的实现\n\n关于 catch 方法可以参考 catch()，实现该方法其实非常简单，只需要在内部调用 then 方法，不传递第一个回调函数即可\n\n**关键实现**\n\n```js\ncatch(callback) {\n    return this.then(null, callback);\n}\n```\n\n**测试代码**\n\n```js\nfunction p() {\n  return new MyPromise((resolve, reject) => {\n    reject(new Error('reject'));\n  });\n}\np()\n  .then((value) => {\n    console.log(value);\n  })\n  .catch((reason) => console.log(reason));\n// 输出\n// Error: reject\n```\n\n## 完整代码\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    try {\n      executor(this.resolve, this.reject);\n    } catch (error) {\n      this.reject(error);\n    }\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递\n    onFulfilled = onFulfilled ? onFulfilled : (value) => value;\n    // 同理\n    onRejected = onRejected\n      ? onRejected\n      : (reason) => {\n          throw reason;\n        };\n\n    // then 方法返回一个 MyPromise 实例\n    const promise = new MyPromise((resolve, reject) => {\n      if (this.status === FULFILLED) {\n        // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n        setTimeout(() => {\n          try {\n            // 将成功的值作为参数返回\n            // 保存执行回调函数的结果\n            const result = onFulfilled(this.value);\n\n            // 如果返回的是一个普通的值，直接调用resolve\n            // 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      }\n\n      // 将失败的原因作为参数返回\n      if (this.status === REJECTED) {\n        // 失败的处理同成功处理，只是调用的回调函数不同\n        setTimeout(() => {\n          try {\n            const result = onRejected(this.reason);\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      }\n\n      if (this.status === PENDING) {\n        // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n        this.onFulfilled.push((value) => {\n          setTimeout(() => {\n            try {\n              const result = onFulfilled(value);\n              resolvePromise(promise, result, resolve, reject);\n            } catch (error) {\n              reject(error);\n            }\n          }, 0);\n        });\n        this.onRejected.push((reason) => {\n          setTimeout(() => {\n            try {\n              const result = onRejected(reason);\n              resolvePromise(promise, result, resolve, reject);\n            } catch (error) {\n              reject(error);\n            }\n          }, 0);\n        });\n      }\n    });\n\n    return promise;\n  };\n\n  finally(callback) {\n    return this.then(\n      (value) => new MyPromise.resolve(callback()).then(() => value),\n      (reason) =>\n        new MyPromise.resolve(callback()).then(() => {\n          throw reason;\n        })\n    );\n  }\n\n  catch(callback) {\n    return this.then(null, callback);\n  }\n\n  static all(array) {\n    // 用于存放最终结果的数组\n    let result = [];\n    // 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置\n    let count = 0;\n\n    // 返回一个 MyPromise 实例\n    return new MyPromise((resolve, reject) => {\n      function addResult(result, index, value, resolve) {\n        // 根据索引值，将结果推入数组中\n        result[index] = value;\n\n        // 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了\n        if (++count === array.length) {\n          // 将执行结果返回\n          resolve(result);\n        }\n      }\n\n      // 遍历传入的数组\n      array.forEach((item, index) => {\n        // 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中\n        if (item instanceof MyPromise) {\n          item.then(\n            (value) => {\n              addResult(result, index, value, resolve);\n            },\n            // 如果失败直接返回失败原因\n            (reason) => {\n              reject(reason);\n            }\n          );\n        } else {\n          addResult(result, index, item, resolve);\n        }\n      });\n    });\n  }\n\n  static resolve(value) {\n    // 如果是MyPromise的实例，就直接返回这个实例\n    if (value instanceof MyPromise) {\n      return value;\n    } else {\n      // 如果不是的话创建一个MyPromise实例，并返回传递的值\n      return new MyPromise((resolve) => resolve(value));\n    }\n  }\n}\n\nfunction resolvePromise(promise, result, resolve, reject) {\n  // 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常\n  if (promise === result) {\n    // 这里调用reject，并抛出一个Error\n    // return 是必须的，阻止程序向下执行\n    return reject(\n      new TypeError('Chaining cycle detected for promise #<Promise>')\n    );\n  } else {\n    // 判断 result 是不是 MyPromise 实例\n    if (result instanceof MyPromise) {\n      // 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject\n      result.then(resolve, reject);\n    } else {\n      resolve(result);\n    }\n  }\n}\n```\n","source":"_posts/promise-detail.md","raw":"---\n# layout: page\ntitle: Promise详解\ndate: 2023-01-31 11:46:20\ncategories: [前端]\ntags: [ES6, Promise]\ntoc: true\n---\n\n## 前言\n\nPromise 是 ES6 异步编程的核心，很多库的异步都从回调向 Promise 转变，Promise 在前端领域发挥着越来越重要的作用；掌握 Promise 的正确使用、理解 Promise 的实现成为了现代前端开发者不可或缺的技能。\n\n<!--\n### Promise 是什么\n\n### Promise 如何使用\n\n### Promise 什么场景|时候使用\n-->\n\n## Promise 的核心原理实现\n\n首先我们从 Promise 的定义和使用方式开始分析 Promise。\n\n### Promise 的使用分析\n\nPromise 是一个类，在执行这个类的时候，需要传递一个执行器参数，执行器会立即执行。\n\n#### Promise 的三个状态\n\n- pending → 等待\n- fulfilled → 成功\n- rejected → 失败\n\n#### 状态切换\n\n- pending → fulfilled\n- pending → rejected\n\n#### 一旦状态发生改变，状态将不可变\n\n- 执行器中的两个参数，分别是 resolve 和 reject，其实就是两个回调函数，调用 resolve 是从 pending 状态转变为 fulfilled 状态，调用 reject 是从 pending 状态转变为 rejected 状态。传递给这两个回调函数的参数会作为成功或失败的值。\n- Promise 实例对象具有一个 then 方法，该方法接受两个回调函数，分别来处理成功与失败的状态，then 方法内部会进行判断，然后根据当前的状态调用对应的回调函数。then 方法应该是被定义在原型对象中的。\n- then 的回调函数中都包含一个值，如果是成功，表示成功后返回的值；如果是失败，就表示失败的原因。\n\n### MyPromise 的实现\n\n根据上述分析，我们可以给出如下实现：\n\n```js\n// 所有状态\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n// Promise 本质上是一个类\nclass MyPromise {\n  constructor(executor) {\n    // 实例化Promise时需要一个执行器回调，该回调立即执行\n    executor(this.resolve, this.reject);\n  }\n\n  //   Promise 的初始状态;\n  status = PENDING;\n  // 记录成功与失败的值\n  value = undefined;\n  reason = undefined;\n\n  // 此处使用箭头函数为了解决resolve调用中this的指向问题\n  resolve = (value) => {\n    // 如果状态不是 PENDING 直接跳出该逻辑\n    if (this.status !== PENDING) return;\n    // 将状态修改为 成功\n    this.status = FULFILLED;\n\n    // 将 resolve 回调的参数进行保存\n    this.value = value;\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) return;\n\n    // 将状态修改为失败\n    this.status = REJECTED;\n\n    // 保存失败的原因\n    this.reason = reason;\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // 根据当前状态指定回调\n    if (this.status === FULFILLED) {\n      // 将成功的值作为回调函数的参数返回\n      onFulfilled(this.value);\n    } else if (this.status === REJECTED) {\n      // 将失败的值作为回调函数的参数返回\n      onRejected(this.reason);\n    }\n  };\n}\n```\n\n接下来我们给出一段验证代码：\n\n**验证 resolve**\n\n```js\nconst MyPromise = require('./my-promise');\n\nconst promise = new MyPromise((resolve, reject) => {\n  resolve('Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\n// Hello Promise Resolve~\n```\n\n**验证 reject**\n\n```js\nconst MyPromise = require('./my-promise');\n\nconst promise = new MyPromise((resolve, reject) => {\n  reject('Hello Promise Reject~');\n});\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\n// Hello Promise Reject~\n```\n\n**验证状态不可变**\n\n```js\nconst MyPromise = require('./my-promise');\n\nconst promise = new MyPromise((resolve, reject) => {\n  resolve('Hello Promise Resolve~');\n  reject('Hello Promise Reject~');\n});\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\n// Hello Promise Resolve~\n```\n\n**测试异步**\n\n上述简易版 Promise 中如果存在异步操作将无法正确处理\n\n```js\nconst MyPromise = require('./my-promise');\nconst promise = new MyPromise((resole, reject) => {\n  setTimeout(resolve, 2000, 'Hello Promise Resolve~');\n});\n\npromise.then(\n  (value) => {\n    console.log(value);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n```\n\n上述代码将不会有任何输出\n\n**原因分析**\n\n- MyPromise 的实现中没有考虑异步的实现，在异步函数中修改 Promise 的状态后没有调用 then 回调\n- then 回调先于 resolve/reject 执行，此时 Promise 的状态还处于 PENDING，将不会执行任何操作[MyPromise 中未对该阶段进行处理]\n\n### 在 Promise 中加入异步操作\n\n根据 `原因分析` 给出如下解决办法：\n\n1. 创建 `onFulfilled` 和 `onRejected` 两个属性用来存储 then 中的回调\n2. 为 `then` 方法添加状态为 `PENDING` 的处理逻辑，及时将 onFulfilled 和 onRejected 回调进行存储，便于在异步方法中调用 resolve/reject 变更状态时及时触发对应的 then 中的回调\n3. 在成功或失败时及时调用对应的 onFulfilled 或者 onRejected 回调\n\n增加异步操作的 Promise 实现如下：\n\n```js\nclass MyPromise {\n  constructor(executor) {\n    // 实例化Promise时需要一个执行器回调，该回调立即执行\n    executor(this.resolve, this.reject);\n  }\n\n  //   Promise 的初始状态;\n  status = PENDING;\n  // 记录成功与失败的值\n  value = undefined;\n  reason = undefined;\n\n  // then中的onFulfilled和onRejected回调\n  onFulfilled = undefined;\n  onRejected = undefined;\n\n  // 此处使用箭头函数为了解决resolve调用中this的指向问题\n  resolve = (value) => {\n    // 如果状态不是 PENDING 直接跳出该逻辑\n    if (this.status !== PENDING) return;\n    // 将状态修改为 成功\n    this.status = FULFILLED;\n\n    // 将 resolve 回调的参数进行保存\n    this.value = value;\n\n    // 如果状态变更为 成功，调用成功的回调\n    this.onFulfilled && this.onFulfilled(this.value);\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) return;\n\n    // 将状态修改为失败\n    this.status = REJECTED;\n\n    // 保存失败的原因\n    this.reason = reason;\n\n    // 如果状态变更为 失败，调用失败的回调\n    this.onRejected && this.onRejected(this.reason);\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // 根据当前状态指定回调\n    if (this.status === FULFILLED) {\n      // 将成功的值作为回调函数的参数返回\n      onFulfilled(this.value);\n    } else if (this.status === REJECTED) {\n      // 将失败的值作为回调函数的参数返回\n      onRejected(this.reason);\n    } else {\n      // 既不是成功也不是失败。这个时候保存传递进来的两个回调，便于 异步操作中 更新 Promise 状态时，触发对应的回调\n      this.onFulfilled = onFulfilled;\n      this.onRejected = onRejected;\n    }\n  };\n}\n```\n\n**验证多次 then 调用**\n\n```js\nconst promise = new MyPromise((resolve) => {\n  setTimeout(resolve, 2000, 'Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value + ' first.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    console.log(value + ' second.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    setTimeout(() => {\n      console.log(value + ' third.');\n    }, 1000);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n// 3s后输出： Hello Promise Resolve~ third.\n```\n\n**原因分析**\n\n如果执行器中存在**异步逻辑**，`then 函数又先于 异步逻辑 执行`，导致多次 `then` 调用存在覆盖 bug，即在后面的 then 调用会覆盖前面的 `then` 回调\n\n### 实现 then 方法的多次调用\n\n根据 `原因分析` 给出如下解决方案：\n\n1. 将保存 `then` 回调的 onFulfilled 和 onRejected 属性改为数组形式，便于存储多个 `then` 回调.\n\n增加存储多次 then 回调的实现如下：\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    executor(this.resolve, this.reject);\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    if (this.status === FULFILLED) {\n      onFulfilled(this.value);\n    }\n\n    if (this.status === REJECTED) {\n      onRejected(this.reason);\n    }\n\n    if (this.status === PENDING) {\n      // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n      this.onFulfilled.push(onFulfilled);\n      this.onRejected.push(onRejected);\n    }\n  };\n}\n```\n\n**验证多次 then 调用**\n\n```js\nconst promise = new MyPromise((resolve) => {\n  resolve('Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value + ' first.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    console.log(value + ' second.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    setTimeout(() => {\n      console.log(value + ' third.');\n    }, 1000);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n// 输出\n// 立即输出：\n// Hello Promise Resolve~ first.\n// Hello Promise Resolve~ second.\n// 1s后输出\n// Hello Promise Resolve~ third.\n\nconst promise = new MyPromise((resolve) => {\n  setTimeout(resolve, 2000, 'Hello Promise Resolve~');\n});\npromise.then(\n  (value) => {\n    console.log(value + ' first.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    console.log(value + ' second.');\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\npromise.then(\n  (value) => {\n    setTimeout(() => {\n      console.log(value + ' third.');\n    }, 1000);\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n// 输出\n// 2s后输出：\n// Hello Promise Resolve~ first.\n// Hello Promise Resolve~ second.\n// 3s后输出\n// Hello Promise Resolve~ third.\n```\n\n### <text style=\"color: red;\">实现 then 方法的链式调用[难点]</text>\n\n**要想实现 then 的链式调用，主要需要解决两个问题：**\n\n1. 返回的是一个新的 `MyPromise` 的实例；\n2. `then` 的返回值作为下一次的链式调用的参数。\n\n**这里分为两种情况：**\n\n1. 直接返回一个值，可以直接作为值使用；\n2. 返回一个新的 `MyPromise` 实例，此时就需要判断其状态；\n\n**代码实现**：\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    executor(this.resolve, this.reject);\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // then 方法返回一个 MyPromise 实例\n    return new MyPromise((resolve, reject) => {\n      if (this.status === FULFILLED) {\n        const result = onFulfilled(this.value);\n\n        // 如果result是一个普通值，直接resolve(result)\n        // 如果是一个 MyPromise 实例，根据返回的解决来决定时调用 resolve 还是 reject\n        resolvePromise(result, resolve, reject);\n      }\n\n      if (this.status === REJECTED) {\n        onRejected(this.reason);\n      }\n\n      if (this.status === PENDING) {\n        // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n        this.onFulfilled.push(onFulfilled);\n        this.onRejected.push(onRejected);\n      }\n    });\n  };\n}\n\nfunction resolvePromise(result, resolve, reject) {\n  if (result instanceof MyPromise) {\n    result.then(resolve, reject);\n  } else {\n    resolve(result);\n  }\n}\n```\n\n**验证链式调用**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  resolve('Hello Promise Resolve~');\n});\nconst promise2 = promise1.then(\n  (value) => {\n    console.log(value + ' promise1.');\n    // 当前 Promise 的 resolve 回调函数的返回值将作为下一个链式调用的 then 中的 onFulfilled 回调函数的参数值\n    return 'Hello Promise2 Resolve~';\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\npromise2.then(\n  // 此处的 value 即为 'Hello Promise2 Resolve~'\n  (value) => {\n    console.log(value + ` promise2.`);\n  },\n  (reason) => {\n    console.log(reason + ` promise2.`);\n  }\n);\n\n// 输出：\n// Hello Promise Resolve~ promise1.\n// Hello Promise2 Resolve~ promise2.\n```\n\n### then 方法链式调用识别 Promise 对象自返回 [难点]\n\n在 Promise 中，如果 `then` 方法返回的是自己的 `Promise` 对象，则会发生 `Promise` 的嵌套，这个时候程序会报错。\n\n**测试代码**\n\n```js\nconst p1 = new Promise((resolve, reject) => {\n  resolve(12);\n});\nconst p2 = p1.then((v) => {\n  console.log(v);\n  return p2;\n});\np2.then((v) => console.log(v));\n\n// 输出：\n// 12\n// Promise {<rejected>: TypeError: Chaining cycle detected for promise #<Promise>}\n// Uncaught (in promise) TypeError: Chaining cycle detected for promise #<Promise>\n```\n\n**解决办法**\n\n只需判断 `then` 返回的 Promise 实例与 then 中回调函数返回的实例是否是同一个即可，如果是引用的同一个实例，那么就抛出错误\n\n**实现代码**\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    executor(this.resolve, this.reject);\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // then 方法返回一个 MyPromise 实例\n    const promise = new MyPromise((resolve, reject) => {\n      if (this.status === FULFILLED) {\n        // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n        setTimeout(() => {\n          const result = onFulfilled(this.value);\n\n          resolvePromise(promise, result, resolve, reject);\n        }, 0);\n      }\n\n      if (this.status === REJECTED) {\n        onRejected(this.reason);\n      }\n\n      if (this.status === PENDING) {\n        // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n        this.onFulfilled.push(onFulfilled);\n        this.onRejected.push(onRejected);\n      }\n    });\n\n    return promise;\n  };\n}\n\nfunction resolvePromise(promise, result, resolve, reject) {\n  // 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常\n  if (promise === result) {\n    // 这里调用reject，并抛出一个Error\n    // return 是必须的，阻止程序向下执行\n    return reject(\n      new TypeError('Chaining cycle detected for promise #<Promise>')\n    );\n  } else {\n    // 判断 result 是不是 MyPromise 实例\n    if (result instanceof MyPromise) {\n      // 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject\n      result.then(resolve, reject);\n    } else {\n      resolve(result);\n    }\n  }\n}\n```\n\n> 这里 then 方法中的 setTimeout 的作用并不是延迟执行，而是为了调用 resolvePromise 函数时，保证创建的 promise 存在。\n\n**验证代码**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  resolve('Hello Promise Resolve~');\n});\nconst promise2 = promise1.then(\n  (value) => {\n    console.log(value + ' promise1.');\n    return promise2;\n  },\n  (reason) => {\n    console.log(reason);\n  }\n);\n\npromise2.then(\n  (value) => {\n    console.log(value + ` promise2.`);\n  },\n  (reason) => {\n    console.log(reason + ` promise2.`);\n  }\n);\n// 输出：\n// Hello Promise Resolve~ promise1.\n// TypeError: Chaining cycle detected for promise #<Promise> promise2.\n```\n\n## 捕捉错误及 then 链式调用其他状态代码补充\n\n到目前为止我们实现的 Promise 并没有对异常做任何处理，为了保证代码的健壮性，我们需要对异常做一些处理。\n\n### 捕捉执行器报错\n\n如果执行器函数在执行过程中发生了异常，需要捕获异常并且在捕获逻辑中调用 reject 将异常传出去\n\n**关键实现代码**\n\n```js\nconstructor(executor) {\n  try {\n    executor(this.resolve, this.reject);\n  } catch (error) {\n    this.reject(error);\n  }\n}\n```\n\n**测试代码**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  throw new Error('执行器异常');\n});\npromise1.then(console.log, console.log);\n\n// 输出：\n// Error: 执行器异常\n//     at E:\\blog\\source\\_posts\\my-promise.js:100:11\n//     at new MyPromise (E:\\blog\\source\\_posts\\my-promise.js:14:13)\n//     at Object.<anonymous> (E:\\blog\\source\\_posts\\my-promise.js:99:18)\n//     at Module._compile (node:internal/modules/cjs/loader:1126:14)\n//     at Object.Module._extensions..js (node:internal/modules/cjs/loader:1180:10)\n//     at Module.load (node:internal/modules/cjs/loader:1004:32)\n//     at Function.Module._load (node:internal/modules/cjs/loader:839:12)\n//     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)\n//     at node:internal/main/run_main_module:17:47\n```\n\n### 捕捉 then 中的报错\n\n如果需要捕获 `then` 中的异常，与执行器中同理，需要在 then 中将捕获到的异常通过 reject 传递出去，异常需要通过 `try...catch` 捕获。\n\n**关键实现代码**\n\n```js\nthen = (onFulfilled, onRejected) => {\n  // then 方法返回一个 MyPromise 实例\n  const promise = new MyPromise((resolve, reject) => {\n    if (this.status === FULFILLED) {\n      // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n      setTimeout(() => {\n        try {\n          // 将成功的值作为参数返回\n          // 保存执行回调函数的结果\n          const result = onFulfilled(this.value);\n\n          // 如果返回的是一个普通的值，直接调用resolve\n          // 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject\n          resolvePromise(promise, result, resolve, reject);\n        } catch (error) {\n          reject(error);\n        }\n      }, 0);\n    }\n\n    // 将失败的原因作为参数返回\n    if (this.status === REJECTED) {\n      onRejected(this.reason);\n    }\n\n    if (this.status === PENDING) {\n      // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n      this.onFulfilled.push(onFulfilled);\n      this.onRejected.push(onRejected);\n    }\n  });\n\n  return promise;\n};\n```\n\n**测试代码**\n\n```js\nconst promise1 = new MyPromise((resolve) => {\n  resolve(Math.PI);\n});\npromise1\n  .then((pi) => console.log(2 * pi * r), console.log)\n  .then(console.log, console.log);\n\n// 输出：\n// ReferenceError: r is not defined\n//     at E:\\blog\\source\\_posts\\my-promise.js:112:40\n//     at Timeout._onTimeout (E:\\blog\\source\\_posts\\my-promise.js:64:40)\n//     at listOnTimeout (node:internal/timers:559:17)\n//     at processTimers (node:internal/timers:502:7)\n```\n\n### 错误与异步状态的链式调用\n\n目前只对成功状态的 then 进行了链式调用以及错误处理，错误与异步状态未进行处理，参照成功状态下的错误处理进行实现\n\n**关键实现代码**\n\n```js\nthen = (onFulfilled, onRejected) => {\n  // then 方法返回一个 MyPromise 实例\n  const promise = new MyPromise((resolve, reject) => {\n    if (this.status === FULFILLED) {\n      // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n      setTimeout(() => {\n        try {\n          // 将成功的值作为参数返回\n          // 保存执行回调函数的结果\n          const result = onFulfilled(this.value);\n\n          // 如果返回的是一个普通的值，直接调用resolve\n          // 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject\n          resolvePromise(promise, result, resolve, reject);\n        } catch (error) {\n          reject(error);\n        }\n      }, 0);\n    }\n\n    // 将失败的原因作为参数返回\n    if (this.status === REJECTED) {\n      // 失败的处理同成功处理，只是调用的回调函数不同\n      setTimeout(() => {\n        try {\n          const result = onRejected(this.reason);\n          resolvePromise(promise, result, resolve, reject);\n        } catch (error) {\n          reject(error);\n        }\n      }, 0);\n    }\n\n    if (this.status === PENDING) {\n      // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n      this.onFulfilled.push((value) => {\n        setTimeout(() => {\n          try {\n            const result = onFulfilled(value);\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      });\n      this.onRejected.push((reason) => {\n        setTimeout(() => {\n          try {\n            const result = onRejected(reason);\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      });\n    }\n  });\n\n  return promise;\n};\n```\n\n**测试代码**\n\n```js\nconst MyPromise = require('./myPromise');\nlet promise = new MyPromise((resolve, reject) => {\n  setTimeout(resolve, 2000, '成功');\n});\n// 第一个then方法中的错误要在第二个then方法中捕获到\npromise\n  .then((value) => {\n    console.log('resolve', value);\n    throw new Error('then的执行过程中遇到异常');\n  })\n  .then(null, (reason) => {\n    console.log(reason.message);\n  });\n/* 输出\n    resolve 成功\n    then的执行过程中遇到异常\n*/\n```\n\n## 将 then 方法的参数变成可选参数\n\nPromise 中的 then 方法其实是两个*可选参数*，如果我们不传递任何参数的话，里面的结果是向下传递的，直到捕获为止。\n\n**示例代码**\n\n```js\nnew Promise((resolve, reject) => {\n  resolve(100);\n})\n  .then()\n  .then()\n  .then()\n  .then((value) => console.log(value));\n// 最后一个then输入100\n```\n\n**这段代码可以理解为**\n\n```js\nnew Promise((resolve, reject) => {\n  resolve(100);\n})\n  .then((value) => value)\n  .then((value) => value)\n  .then((value) => value)\n  .then((value) => console.log(value));\n```\n\n**关键实现**\n\n```js\n// then方法的实现\nthen (onFulfilled, onRejected) {\n    // 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递\n    onFulfilled = onFulfilled ? onFulfilled : value => value\n    // 同理\n    onRejected = onRejected ? onRejected : reason => { throw reason }\n    // then 方法返回一个MyPromise实例\n    const promise = new MyPromise((resolve, reject) => {\n        // 判断当前状态,根据状态调用指定回调\n        if (this.status === FULFILLED) {...\n        } else if (this.status === REJECTED) {...\n        } else {...\n        }\n    })\n    return promise\n}\n```\n\n## Promise.all 方法的实现\n\n简单的说 `Promise.all()` 会将多个 Promise 实例包装为一个 Promise 实例，且顺序与调用顺序一致:\n**示例代码**\n\n```js\nfunction p1() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p1');\n    }, 2000);\n  });\n}\nfunction p2() {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p2');\n    }, 0);\n  });\n}\nPromise.all(['a', 'b', p1(), p2(), 'c']).then((result) => {\n  console.log(result);\n  // [\"a\", \"b\", \"p1\", \"p2\", \"c\"]\n});\n```\n\n在这段代码中，我们的 p1 的执行是延迟了 2s 的，这里如果不使用 Promise.all()的话最终顺序是与我们调用不同的。\n\n**分析 Promise.all 的实现思路**\n\n- `all()` 方法是通过类直接调用的，所以是一个静态方法\n- `all()` 方法接收一个数组，数组中的值可以是一个普通值，也可以是一个 MyPromise 实例\n- return 一个新的 MyPromise 实例\n- 遍历数组中的每一个值，判断值的类型，如果是一个普通值就直接将值存入一个结果数组；如果是一个 MyPromise 实例对象，会调用其 then 方法，然后根据执行后的状态，如果失败的话调用 MyPromise 的 reject 方法，如果成功的话将值存入结果数组；\n- 存入数组时计数，如果存入的数量达到传入的数组长度，说明调用完毕，执行 `resolve` 并将最终的结果数组作为参数返回。\n\n**关键实现**\n\n```js\nMyPromise.all = (array) => {\n  // 用于存放最终结果的数组\n  let result = [];\n  // 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置\n  let count = 0;\n\n  // 返回一个 MyPromise 实例\n  return new MyPromise((resolve, reject) => {\n    function addResult(result, index, value, resolve) {\n      // 根据索引值，将结果推入数组中\n      result[index] = value;\n\n      // 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了\n      if (++count === array.length) {\n        // 将执行结果返回\n        resolve(result);\n      }\n    }\n\n    // 遍历传入的数组\n    array.forEach((item, index) => {\n      // 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中\n      if (item instanceof MyPromise) {\n        item.then(\n          (value) => {\n            addResult(result, index, value, resolve);\n          },\n          // 如果失败直接返回失败原因\n          (reason) => {\n            reject(reason);\n          }\n        );\n      } else {\n        addResult(result, index, item, resolve);\n      }\n    });\n  });\n};\n```\n\n**测试示例**\n\n```js\nfunction p1() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p1');\n    }, 2000);\n  });\n}\nfunction p2() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p2');\n    }, 0);\n  });\n}\nMyPromise.all(['a', 'b', p1(), p2(), 'c']).then((result) => {\n  console.log(result);\n  // [\"a\", \"b\", \"p1\", \"p2\", \"c\"]\n});\n```\n\n## Promise.resolve 方法的实现\n\n关于 Promise.resolve()方法的用法可以参考 Promise.resolve()与 Promise.reject()。\n**直线思路分析**\n\n- 该方法是一个静态方法\n- 该方法接收的如果是一个值就直接将该值包装为一个 MyPromise 实例对象返回,如果是一个 MyPromise 实例对象,则直接返回\n\n**关键实现**\n\n```js\nMyPromise.resolve = (value) => {\n  // 如果是MyPromise的实例，就直接返回这个实例\n  if (value instanceof MyPromise) {\n    return value;\n  } else {\n    // 如果不是的话创建一个MyPromise实例，并返回传递的值\n    return new MyPromise((resolve) => resolve(value));\n  }\n};\n```\n\n**测试代码**\n\n```js\nfunction p1() {\n  return new MyPromise((resolve, reject) => {\n    reject('p1');\n  });\n}\nfunction p2() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p2');\n    }, 2000);\n  });\n}\nMyPromise.resolve(p1()).then(console.log, console.log);\nMyPromise.resolve(3.1415926).then(console.log);\nMyPromise.resolve(p2()).then(console.log, console.log);\n// 输出\n// p1\n// 3.1415926\n// 2s后输出\n// p2\n```\n\n## finally 方法的实现\n\n**实现思路分析**\n\n- 不管 Promise 是 Fulfilled 还是 Rejected 状态,都会调用 finally 函数中的回调参数\n- 返回一个新的 Promise 实例\n\n**关键实现**\n\n```js\nfinally(callback) {\n    return this.then(\n        value => new MyPromise.resolve(callback()).then(() => value),\n        reason => new MyPromise.resolve(callback()).then(() => { throw reason })\n    );\n}\n```\n\n**测试代码**\n\n```js\nfunction p1() {\n  return new MyPromise((resolve, reject) => {\n    setTimeout(() => {\n      resolve('p1');\n    }, 2000);\n  });\n}\nfunction p2() {\n  return new MyPromise((resolve, reject) => {\n    reject('p2 reject');\n  });\n}\np2()\n  .finally(() => {\n    console.log('finally p2');\n    return p1();\n  })\n  .then(\n    (value) => {\n      console.log(value);\n    },\n    (reason) => {\n      console.log(reason);\n    }\n  );\n// finally p2\n// 两秒之后执行p2 reject\n```\n\n## catch 方法的实现\n\n关于 catch 方法可以参考 catch()，实现该方法其实非常简单，只需要在内部调用 then 方法，不传递第一个回调函数即可\n\n**关键实现**\n\n```js\ncatch(callback) {\n    return this.then(null, callback);\n}\n```\n\n**测试代码**\n\n```js\nfunction p() {\n  return new MyPromise((resolve, reject) => {\n    reject(new Error('reject'));\n  });\n}\np()\n  .then((value) => {\n    console.log(value);\n  })\n  .catch((reason) => console.log(reason));\n// 输出\n// Error: reject\n```\n\n## 完整代码\n\n```js\n/**\n * 定义所有状态常量\n */\nconst PENDING = 'pending';\nconst FULFILLED = 'fulfilled';\nconst REJECTED = 'rejected';\n\n/**\n * Promise是一个类\n */\nclass MyPromise {\n  constructor(executor) {\n    try {\n      executor(this.resolve, this.reject);\n    } catch (error) {\n      this.reject(error);\n    }\n  }\n\n  status = PENDING;\n  value = undefined;\n  reason = undefined;\n\n  onFulfilled = [];\n  onRejected = [];\n\n  resolve = (value) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = FULFILLED;\n    this.value = value;\n\n    while (this.onFulfilled.length) {\n      this.onFulfilled.shift()(this.value);\n    }\n  };\n\n  reject = (reason) => {\n    if (this.status !== PENDING) {\n      return;\n    }\n\n    this.status = REJECTED;\n    this.reason = reason;\n\n    while (this.onRejected.length) {\n      this.onRejected.shift()(this.reason);\n    }\n  };\n\n  then = (onFulfilled, onRejected) => {\n    // 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递\n    onFulfilled = onFulfilled ? onFulfilled : (value) => value;\n    // 同理\n    onRejected = onRejected\n      ? onRejected\n      : (reason) => {\n          throw reason;\n        };\n\n    // then 方法返回一个 MyPromise 实例\n    const promise = new MyPromise((resolve, reject) => {\n      if (this.status === FULFILLED) {\n        // 如果不用异步是拿不到 then 中生成的新 Promise 实例的\n        setTimeout(() => {\n          try {\n            // 将成功的值作为参数返回\n            // 保存执行回调函数的结果\n            const result = onFulfilled(this.value);\n\n            // 如果返回的是一个普通的值，直接调用resolve\n            // 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      }\n\n      // 将失败的原因作为参数返回\n      if (this.status === REJECTED) {\n        // 失败的处理同成功处理，只是调用的回调函数不同\n        setTimeout(() => {\n          try {\n            const result = onRejected(this.reason);\n            resolvePromise(promise, result, resolve, reject);\n          } catch (error) {\n            reject(error);\n          }\n        }, 0);\n      }\n\n      if (this.status === PENDING) {\n        // 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调\n        this.onFulfilled.push((value) => {\n          setTimeout(() => {\n            try {\n              const result = onFulfilled(value);\n              resolvePromise(promise, result, resolve, reject);\n            } catch (error) {\n              reject(error);\n            }\n          }, 0);\n        });\n        this.onRejected.push((reason) => {\n          setTimeout(() => {\n            try {\n              const result = onRejected(reason);\n              resolvePromise(promise, result, resolve, reject);\n            } catch (error) {\n              reject(error);\n            }\n          }, 0);\n        });\n      }\n    });\n\n    return promise;\n  };\n\n  finally(callback) {\n    return this.then(\n      (value) => new MyPromise.resolve(callback()).then(() => value),\n      (reason) =>\n        new MyPromise.resolve(callback()).then(() => {\n          throw reason;\n        })\n    );\n  }\n\n  catch(callback) {\n    return this.then(null, callback);\n  }\n\n  static all(array) {\n    // 用于存放最终结果的数组\n    let result = [];\n    // 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置\n    let count = 0;\n\n    // 返回一个 MyPromise 实例\n    return new MyPromise((resolve, reject) => {\n      function addResult(result, index, value, resolve) {\n        // 根据索引值，将结果推入数组中\n        result[index] = value;\n\n        // 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了\n        if (++count === array.length) {\n          // 将执行结果返回\n          resolve(result);\n        }\n      }\n\n      // 遍历传入的数组\n      array.forEach((item, index) => {\n        // 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中\n        if (item instanceof MyPromise) {\n          item.then(\n            (value) => {\n              addResult(result, index, value, resolve);\n            },\n            // 如果失败直接返回失败原因\n            (reason) => {\n              reject(reason);\n            }\n          );\n        } else {\n          addResult(result, index, item, resolve);\n        }\n      });\n    });\n  }\n\n  static resolve(value) {\n    // 如果是MyPromise的实例，就直接返回这个实例\n    if (value instanceof MyPromise) {\n      return value;\n    } else {\n      // 如果不是的话创建一个MyPromise实例，并返回传递的值\n      return new MyPromise((resolve) => resolve(value));\n    }\n  }\n}\n\nfunction resolvePromise(promise, result, resolve, reject) {\n  // 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常\n  if (promise === result) {\n    // 这里调用reject，并抛出一个Error\n    // return 是必须的，阻止程序向下执行\n    return reject(\n      new TypeError('Chaining cycle detected for promise #<Promise>')\n    );\n  } else {\n    // 判断 result 是不是 MyPromise 实例\n    if (result instanceof MyPromise) {\n      // 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject\n      result.then(resolve, reject);\n    } else {\n      resolve(result);\n    }\n  }\n}\n```\n","slug":"promise-detail","published":1,"updated":"2023-06-28T09:32:50.978Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljfka1kf0005dcv4f1mhb2yh","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Promise 是 ES6 异步编程的核心，很多库的异步都从回调向 Promise 转变，Promise 在前端领域发挥着越来越重要的作用；掌握 Promise 的正确使用、理解 Promise 的实现成为了现代前端开发者不可或缺的技能。</p>\n<!--\n### Promise 是什么\n\n### Promise 如何使用\n\n### Promise 什么场景|时候使用\n-->\n\n<h2 id=\"Promise-的核心原理实现\"><a href=\"#Promise-的核心原理实现\" class=\"headerlink\" title=\"Promise 的核心原理实现\"></a>Promise 的核心原理实现</h2><p>首先我们从 Promise 的定义和使用方式开始分析 Promise。</p>\n<h3 id=\"Promise-的使用分析\"><a href=\"#Promise-的使用分析\" class=\"headerlink\" title=\"Promise 的使用分析\"></a>Promise 的使用分析</h3><p>Promise 是一个类，在执行这个类的时候，需要传递一个执行器参数，执行器会立即执行。</p>\n<h4 id=\"Promise-的三个状态\"><a href=\"#Promise-的三个状态\" class=\"headerlink\" title=\"Promise 的三个状态\"></a>Promise 的三个状态</h4><ul>\n<li>pending → 等待</li>\n<li>fulfilled → 成功</li>\n<li>rejected → 失败</li>\n</ul>\n<h4 id=\"状态切换\"><a href=\"#状态切换\" class=\"headerlink\" title=\"状态切换\"></a>状态切换</h4><ul>\n<li>pending → fulfilled</li>\n<li>pending → rejected</li>\n</ul>\n<h4 id=\"一旦状态发生改变，状态将不可变\"><a href=\"#一旦状态发生改变，状态将不可变\" class=\"headerlink\" title=\"一旦状态发生改变，状态将不可变\"></a>一旦状态发生改变，状态将不可变</h4><ul>\n<li>执行器中的两个参数，分别是 resolve 和 reject，其实就是两个回调函数，调用 resolve 是从 pending 状态转变为 fulfilled 状态，调用 reject 是从 pending 状态转变为 rejected 状态。传递给这两个回调函数的参数会作为成功或失败的值。</li>\n<li>Promise 实例对象具有一个 then 方法，该方法接受两个回调函数，分别来处理成功与失败的状态，then 方法内部会进行判断，然后根据当前的状态调用对应的回调函数。then 方法应该是被定义在原型对象中的。</li>\n<li>then 的回调函数中都包含一个值，如果是成功，表示成功后返回的值；如果是失败，就表示失败的原因。</li>\n</ul>\n<h3 id=\"MyPromise-的实现\"><a href=\"#MyPromise-的实现\" class=\"headerlink\" title=\"MyPromise 的实现\"></a>MyPromise 的实现</h3><p>根据上述分析，我们可以给出如下实现：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 所有状态</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Promise 本质上是一个类</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 实例化Promise时需要一个执行器回调，该回调立即执行</span></span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//   Promise 的初始状态;</span></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 记录成功与失败的值</span></span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 此处使用箭头函数为了解决resolve调用中this的指向问题</span></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果状态不是 PENDING 直接跳出该逻辑</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为 成功</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将 resolve 回调的参数进行保存</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为失败</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 保存失败的原因</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 根据当前状态指定回调</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将成功的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将失败的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>接下来我们给出一段验证代码：</p>\n<p><strong>验证 resolve</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>验证 reject</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;Hello Promise Reject~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Reject~</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>验证状态不可变</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">  <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;Hello Promise Reject~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>测试异步</strong></p>\n<p>上述简易版 Promise 中如果存在异步操作将无法正确处理</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resole, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>上述代码将不会有任何输出</p>\n<p><strong>原因分析</strong></p>\n<ul>\n<li>MyPromise 的实现中没有考虑异步的实现，在异步函数中修改 Promise 的状态后没有调用 then 回调</li>\n<li>then 回调先于 resolve&#x2F;reject 执行，此时 Promise 的状态还处于 PENDING，将不会执行任何操作[MyPromise 中未对该阶段进行处理]</li>\n</ul>\n<h3 id=\"在-Promise-中加入异步操作\"><a href=\"#在-Promise-中加入异步操作\" class=\"headerlink\" title=\"在 Promise 中加入异步操作\"></a>在 Promise 中加入异步操作</h3><p>根据 <code>原因分析</code> 给出如下解决办法：</p>\n<ol>\n<li>创建 <code>onFulfilled</code> 和 <code>onRejected</code> 两个属性用来存储 then 中的回调</li>\n<li>为 <code>then</code> 方法添加状态为 <code>PENDING</code> 的处理逻辑，及时将 onFulfilled 和 onRejected 回调进行存储，便于在异步方法中调用 resolve&#x2F;reject 变更状态时及时触发对应的 then 中的回调</li>\n<li>在成功或失败时及时调用对应的 onFulfilled 或者 onRejected 回调</li>\n</ol>\n<p>增加异步操作的 Promise 实现如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 实例化Promise时需要一个执行器回调，该回调立即执行</span></span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//   Promise 的初始状态;</span></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 记录成功与失败的值</span></span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// then中的onFulfilled和onRejected回调</span></span><br><span class=\"line\">  onFulfilled = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  onRejected = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 此处使用箭头函数为了解决resolve调用中this的指向问题</span></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果状态不是 PENDING 直接跳出该逻辑</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为 成功</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将 resolve 回调的参数进行保存</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果状态变更为 成功，调用成功的回调</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为失败</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 保存失败的原因</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果状态变更为 失败，调用失败的回调</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 根据当前状态指定回调</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将成功的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将失败的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 既不是成功也不是失败。这个时候保存传递进来的两个回调，便于 异步操作中 更新 Promise 状态时，触发对应的回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span> = onFulfilled;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span> = onRejected;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证多次 then 调用</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; first.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; second.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; third.&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 3s后输出： Hello Promise Resolve~ third.</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>原因分析</strong></p>\n<p>如果执行器中存在<strong>异步逻辑</strong>，<code>then 函数又先于 异步逻辑 执行</code>，导致多次 <code>then</code> 调用存在覆盖 bug，即在后面的 then 调用会覆盖前面的 <code>then</code> 回调</p>\n<h3 id=\"实现-then-方法的多次调用\"><a href=\"#实现-then-方法的多次调用\" class=\"headerlink\" title=\"实现 then 方法的多次调用\"></a>实现 then 方法的多次调用</h3><p>根据 <code>原因分析</code> 给出如下解决方案：</p>\n<ol>\n<li>将保存 <code>then</code> 回调的 onFulfilled 和 onRejected 属性改为数组形式，便于存储多个 <code>then</code> 回调.</li>\n</ol>\n<p>增加存储多次 then 回调的实现如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证多次 then 调用</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; first.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; second.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; third.&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// 立即输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ first.</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ second.</span></span><br><span class=\"line\"><span class=\"comment\">// 1s后输出</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ third.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; first.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; second.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; third.&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// 2s后输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ first.</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ second.</span></span><br><span class=\"line\"><span class=\"comment\">// 3s后输出</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ third.</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"实现-then-方法的链式调用-难点\"><a href=\"#实现-then-方法的链式调用-难点\" class=\"headerlink\" title=\"实现 then 方法的链式调用[难点]\"></a><text style=\"color: red;\">实现 then 方法的链式调用[难点]</text></h3><p><strong>要想实现 then 的链式调用，主要需要解决两个问题：</strong></p>\n<ol>\n<li>返回的是一个新的 <code>MyPromise</code> 的实例；</li>\n<li><code>then</code> 的返回值作为下一次的链式调用的参数。</li>\n</ol>\n<p><strong>这里分为两种情况：</strong></p>\n<ol>\n<li>直接返回一个值，可以直接作为值使用；</li>\n<li>返回一个新的 <code>MyPromise</code> 实例，此时就需要判断其状态；</li>\n</ol>\n<p><strong>代码实现</strong>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 如果result是一个普通值，直接resolve(result)</span></span><br><span class=\"line\">        <span class=\"comment\">// 如果是一个 MyPromise 实例，根据返回的解决来决定时调用 resolve 还是 reject</span></span><br><span class=\"line\">        <span class=\"title function_\">resolvePromise</span>(result, resolve, reject);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">        <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolvePromise</span>(<span class=\"params\">result, resolve, reject</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">    result.<span class=\"title function_\">then</span>(resolve, reject);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证链式调用</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">const</span> promise2 = promise1.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; promise1.&#x27;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 当前 Promise 的 resolve 回调函数的返回值将作为下一个链式调用的 then 中的 onFulfilled 回调函数的参数值</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&#x27;Hello Promise2 Resolve~&#x27;</span>;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">promise2.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"comment\">// 此处的 value 即为 &#x27;Hello Promise2 Resolve~&#x27;</span></span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ promise1.</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise2 Resolve~ promise2.</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"then-方法链式调用识别-Promise-对象自返回-难点\"><a href=\"#then-方法链式调用识别-Promise-对象自返回-难点\" class=\"headerlink\" title=\"then 方法链式调用识别 Promise 对象自返回 [难点]\"></a>then 方法链式调用识别 Promise 对象自返回 [难点]</h3><p>在 Promise 中，如果 <code>then</code> 方法返回的是自己的 <code>Promise</code> 对象，则会发生 <code>Promise</code> 的嵌套，这个时候程序会报错。</p>\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> p1 = <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"number\">12</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">const</span> p2 = p1.<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">v</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(v);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> p2;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">p2.<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">v</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(v));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// 12</span></span><br><span class=\"line\"><span class=\"comment\">// Promise &#123;&lt;rejected&gt;: TypeError: Chaining cycle detected for promise #&lt;Promise&gt;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">// Uncaught (in promise) TypeError: Chaining cycle detected for promise #&lt;Promise&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>解决办法</strong></p>\n<p>只需判断 <code>then</code> 返回的 Promise 实例与 then 中回调函数返回的实例是否是同一个即可，如果是引用的同一个实例，那么就抛出错误</p>\n<p><strong>实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">        <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolvePromise</span>(<span class=\"params\">promise, result, resolve, reject</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (promise === result) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这里调用reject，并抛出一个Error</span></span><br><span class=\"line\">    <span class=\"comment\">// return 是必须的，阻止程序向下执行</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">reject</span>(</span><br><span class=\"line\">      <span class=\"keyword\">new</span> <span class=\"title class_\">TypeError</span>(<span class=\"string\">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断 result 是不是 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject</span></span><br><span class=\"line\">      result.<span class=\"title function_\">then</span>(resolve, reject);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里 then 方法中的 setTimeout 的作用并不是延迟执行，而是为了调用 resolvePromise 函数时，保证创建的 promise 存在。</p>\n</blockquote>\n<p><strong>验证代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">const</span> promise2 = promise1.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; promise1.&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise2;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">promise2.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ promise1.</span></span><br><span class=\"line\"><span class=\"comment\">// TypeError: Chaining cycle detected for promise #&lt;Promise&gt; promise2.</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"捕捉错误及-then-链式调用其他状态代码补充\"><a href=\"#捕捉错误及-then-链式调用其他状态代码补充\" class=\"headerlink\" title=\"捕捉错误及 then 链式调用其他状态代码补充\"></a>捕捉错误及 then 链式调用其他状态代码补充</h2><p>到目前为止我们实现的 Promise 并没有对异常做任何处理，为了保证代码的健壮性，我们需要对异常做一些处理。</p>\n<h3 id=\"捕捉执行器报错\"><a href=\"#捕捉执行器报错\" class=\"headerlink\" title=\"捕捉执行器报错\"></a>捕捉执行器报错</h3><p>如果执行器函数在执行过程中发生了异常，需要捕获异常并且在捕获逻辑中调用 reject 将异常传出去</p>\n<p><strong>关键实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&#x27;执行器异常&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise1.<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Error: 执行器异常</span></span><br><span class=\"line\"><span class=\"comment\">//     at E:\\blog\\source\\_posts\\my-promise.js:100:11</span></span><br><span class=\"line\"><span class=\"comment\">//     at new MyPromise (E:\\blog\\source\\_posts\\my-promise.js:14:13)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Object.&lt;anonymous&gt; (E:\\blog\\source\\_posts\\my-promise.js:99:18)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Module._compile (node:internal/modules/cjs/loader:1126:14)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Object.Module._extensions..js (node:internal/modules/cjs/loader:1180:10)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Module.load (node:internal/modules/cjs/loader:1004:32)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Function.Module._load (node:internal/modules/cjs/loader:839:12)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)</span></span><br><span class=\"line\"><span class=\"comment\">//     at node:internal/main/run_main_module:17:47</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"捕捉-then-中的报错\"><a href=\"#捕捉-then-中的报错\" class=\"headerlink\" title=\"捕捉 then 中的报错\"></a>捕捉 then 中的报错</h3><p>如果需要捕获 <code>then</code> 中的异常，与执行器中同理，需要在 then 中将捕获到的异常通过 reject 传递出去，异常需要通过 <code>try...catch</code> 捕获。</p>\n<p><strong>关键实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将成功的值作为参数返回</span></span><br><span class=\"line\">          <span class=\"comment\">// 保存执行回调函数的结果</span></span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">// 如果返回的是一个普通的值，直接调用resolve</span></span><br><span class=\"line\">          <span class=\"comment\">// 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject</span></span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">          <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将失败的原因作为参数返回</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"title class_\">Math</span>.<span class=\"property\">PI</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise1</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">pi</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">2</span> * pi * r), <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// ReferenceError: r is not defined</span></span><br><span class=\"line\"><span class=\"comment\">//     at E:\\blog\\source\\_posts\\my-promise.js:112:40</span></span><br><span class=\"line\"><span class=\"comment\">//     at Timeout._onTimeout (E:\\blog\\source\\_posts\\my-promise.js:64:40)</span></span><br><span class=\"line\"><span class=\"comment\">//     at listOnTimeout (node:internal/timers:559:17)</span></span><br><span class=\"line\"><span class=\"comment\">//     at processTimers (node:internal/timers:502:7)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"错误与异步状态的链式调用\"><a href=\"#错误与异步状态的链式调用\" class=\"headerlink\" title=\"错误与异步状态的链式调用\"></a>错误与异步状态的链式调用</h3><p>目前只对成功状态的 then 进行了链式调用以及错误处理，错误与异步状态未进行处理，参照成功状态下的错误处理进行实现</p>\n<p><strong>关键实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将成功的值作为参数返回</span></span><br><span class=\"line\">          <span class=\"comment\">// 保存执行回调函数的结果</span></span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">// 如果返回的是一个普通的值，直接调用resolve</span></span><br><span class=\"line\">          <span class=\"comment\">// 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject</span></span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">          <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将失败的原因作为参数返回</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 失败的处理同成功处理，只是调用的回调函数不同</span></span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">          <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(value);</span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(reason);</span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./myPromise&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">let</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;成功&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"comment\">// 第一个then方法中的错误要在第二个then方法中捕获到</span></span><br><span class=\"line\">promise</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;resolve&#x27;</span>, value);</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&#x27;then的执行过程中遇到异常&#x27;</span>);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"literal\">null</span>, <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason.<span class=\"property\">message</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"><span class=\"comment\">/* 输出</span></span><br><span class=\"line\"><span class=\"comment\">    resolve 成功</span></span><br><span class=\"line\"><span class=\"comment\">    then的执行过程中遇到异常</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"将-then-方法的参数变成可选参数\"><a href=\"#将-then-方法的参数变成可选参数\" class=\"headerlink\" title=\"将 then 方法的参数变成可选参数\"></a>将 then 方法的参数变成可选参数</h2><p>Promise 中的 then 方法其实是两个<em>可选参数</em>，如果我们不传递任何参数的话，里面的结果是向下传递的，直到捕获为止。</p>\n<p><strong>示例代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value));</span><br><span class=\"line\"><span class=\"comment\">// 最后一个then输入100</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>这段代码可以理解为</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value));</span><br></pre></td></tr></table></figure>\n\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// then方法的实现</span></span><br><span class=\"line\">then (onFulfilled, onRejected) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递</span></span><br><span class=\"line\">    onFulfilled = onFulfilled ? onFulfilled : <span class=\"function\"><span class=\"params\">value</span> =&gt;</span> value</span><br><span class=\"line\">    <span class=\"comment\">// 同理</span></span><br><span class=\"line\">    onRejected = onRejected ? onRejected : <span class=\"function\"><span class=\"params\">reason</span> =&gt;</span> &#123; <span class=\"keyword\">throw</span> reason &#125;</span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个MyPromise实例</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 判断当前状态,根据状态调用指定回调</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Promise-all-方法的实现\"><a href=\"#Promise-all-方法的实现\" class=\"headerlink\" title=\"Promise.all 方法的实现\"></a>Promise.all 方法的实现</h2><p>简单的说 <code>Promise.all()</code> 会将多个 Promise 实例包装为一个 Promise 实例，且顺序与调用顺序一致:<br><strong>示例代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p2&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">Promise</span>.<span class=\"title function_\">all</span>([<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"title function_\">p1</span>(), <span class=\"title function_\">p2</span>(), <span class=\"string\">&#x27;c&#x27;</span>]).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">result</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(result);</span><br><span class=\"line\">  <span class=\"comment\">// [&quot;a&quot;, &quot;b&quot;, &quot;p1&quot;, &quot;p2&quot;, &quot;c&quot;]</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>在这段代码中，我们的 p1 的执行是延迟了 2s 的，这里如果不使用 Promise.all()的话最终顺序是与我们调用不同的。</p>\n<p><strong>分析 Promise.all 的实现思路</strong></p>\n<ul>\n<li><code>all()</code> 方法是通过类直接调用的，所以是一个静态方法</li>\n<li><code>all()</code> 方法接收一个数组，数组中的值可以是一个普通值，也可以是一个 MyPromise 实例</li>\n<li>return 一个新的 MyPromise 实例</li>\n<li>遍历数组中的每一个值，判断值的类型，如果是一个普通值就直接将值存入一个结果数组；如果是一个 MyPromise 实例对象，会调用其 then 方法，然后根据执行后的状态，如果失败的话调用 MyPromise 的 reject 方法，如果成功的话将值存入结果数组；</li>\n<li>存入数组时计数，如果存入的数量达到传入的数组长度，说明调用完毕，执行 <code>resolve</code> 并将最终的结果数组作为参数返回。</li>\n</ul>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"property\">all</span> = <span class=\"function\">(<span class=\"params\">array</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 用于存放最终结果的数组</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> result = [];</span><br><span class=\"line\">  <span class=\"comment\">// 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 返回一个 MyPromise 实例</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">addResult</span>(<span class=\"params\">result, index, value, resolve</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 根据索引值，将结果推入数组中</span></span><br><span class=\"line\">      result[index] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (++count === array.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将执行结果返回</span></span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 遍历传入的数组</span></span><br><span class=\"line\">    array.<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">item, index</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (item <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">        item.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">          <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"title function_\">addResult</span>(result, index, value, resolve);</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"comment\">// 如果失败直接返回失败原因</span></span><br><span class=\"line\">          <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(reason);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">addResult</span>(result, index, item, resolve);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试示例</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p2&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">all</span>([<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"title function_\">p1</span>(), <span class=\"title function_\">p2</span>(), <span class=\"string\">&#x27;c&#x27;</span>]).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">result</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(result);</span><br><span class=\"line\">  <span class=\"comment\">// [&quot;a&quot;, &quot;b&quot;, &quot;p1&quot;, &quot;p2&quot;, &quot;c&quot;]</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Promise-resolve-方法的实现\"><a href=\"#Promise-resolve-方法的实现\" class=\"headerlink\" title=\"Promise.resolve 方法的实现\"></a>Promise.resolve 方法的实现</h2><p>关于 Promise.resolve()方法的用法可以参考 Promise.resolve()与 Promise.reject()。<br><strong>直线思路分析</strong></p>\n<ul>\n<li>该方法是一个静态方法</li>\n<li>该方法接收的如果是一个值就直接将该值包装为一个 MyPromise 实例对象返回,如果是一个 MyPromise 实例对象,则直接返回</li>\n</ul>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"property\">resolve</span> = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果是MyPromise的实例，就直接返回这个实例</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (value <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果不是的话创建一个MyPromise实例，并返回传递的值</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> <span class=\"title function_\">resolve</span>(value));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p2&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">p1</span>()).<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"number\">3.1415926</span>).<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">p2</span>()).<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// p1</span></span><br><span class=\"line\"><span class=\"comment\">// 3.1415926</span></span><br><span class=\"line\"><span class=\"comment\">// 2s后输出</span></span><br><span class=\"line\"><span class=\"comment\">// p2</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"finally-方法的实现\"><a href=\"#finally-方法的实现\" class=\"headerlink\" title=\"finally 方法的实现\"></a>finally 方法的实现</h2><p><strong>实现思路分析</strong></p>\n<ul>\n<li>不管 Promise 是 Fulfilled 还是 Rejected 状态,都会调用 finally 函数中的回调参数</li>\n<li>返回一个新的 Promise 实例</li>\n</ul>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">finally</span>(<span class=\"params\">callback</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">        <span class=\"function\"><span class=\"params\">value</span> =&gt;</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> value),</span><br><span class=\"line\">        <span class=\"function\"><span class=\"params\">reason</span> =&gt;</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123; <span class=\"keyword\">throw</span> reason &#125;)</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;p2 reject&#x27;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title function_\">p2</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">finally</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;finally p2&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">p1</span>();</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(</span><br><span class=\"line\">    <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  );</span><br><span class=\"line\"><span class=\"comment\">// finally p2</span></span><br><span class=\"line\"><span class=\"comment\">// 两秒之后执行p2 reject</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"catch-方法的实现\"><a href=\"#catch-方法的实现\" class=\"headerlink\" title=\"catch 方法的实现\"></a>catch 方法的实现</h2><p>关于 catch 方法可以参考 catch()，实现该方法其实非常简单，只需要在内部调用 then 方法，不传递第一个回调函数即可</p>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">catch</span>(callback) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(<span class=\"literal\">null</span>, callback);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">reject</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&#x27;reject&#x27;</span>));</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title function_\">p</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason));</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// Error: reject</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递</span></span><br><span class=\"line\">    onFulfilled = onFulfilled ? onFulfilled : <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value;</span><br><span class=\"line\">    <span class=\"comment\">// 同理</span></span><br><span class=\"line\">    onRejected = onRejected</span><br><span class=\"line\">      ? onRejected</span><br><span class=\"line\">      : <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">throw</span> reason;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将成功的值作为参数返回</span></span><br><span class=\"line\">            <span class=\"comment\">// 保存执行回调函数的结果</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 如果返回的是一个普通的值，直接调用resolve</span></span><br><span class=\"line\">            <span class=\"comment\">// 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject</span></span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 将失败的原因作为参数返回</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 失败的处理同成功处理，只是调用的回调函数不同</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(value);</span><br><span class=\"line\">              <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">              <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(reason);</span><br><span class=\"line\">              <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">              <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">finally</span>(<span class=\"params\">callback</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">      <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> value),</span><br><span class=\"line\">      <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">throw</span> reason;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">catch</span>(callback) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(<span class=\"literal\">null</span>, callback);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"title function_\">all</span>(<span class=\"params\">array</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 用于存放最终结果的数组</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> result = [];</span><br><span class=\"line\">    <span class=\"comment\">// 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">function</span> <span class=\"title function_\">addResult</span>(<span class=\"params\">result, index, value, resolve</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 根据索引值，将结果推入数组中</span></span><br><span class=\"line\">        result[index] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (++count === array.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将执行结果返回</span></span><br><span class=\"line\">          <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 遍历传入的数组</span></span><br><span class=\"line\">      array.<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">item, index</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (item <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">          item.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">            <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">              <span class=\"title function_\">addResult</span>(result, index, value, resolve);</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"comment\">// 如果失败直接返回失败原因</span></span><br><span class=\"line\">            <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">              <span class=\"title function_\">reject</span>(reason);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          );</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"title function_\">addResult</span>(result, index, item, resolve);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"title function_\">resolve</span>(<span class=\"params\">value</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果是MyPromise的实例，就直接返回这个实例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (value <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果不是的话创建一个MyPromise实例，并返回传递的值</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> <span class=\"title function_\">resolve</span>(value));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolvePromise</span>(<span class=\"params\">promise, result, resolve, reject</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (promise === result) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这里调用reject，并抛出一个Error</span></span><br><span class=\"line\">    <span class=\"comment\">// return 是必须的，阻止程序向下执行</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">reject</span>(</span><br><span class=\"line\">      <span class=\"keyword\">new</span> <span class=\"title class_\">TypeError</span>(<span class=\"string\">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断 result 是不是 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject</span></span><br><span class=\"line\">      result.<span class=\"title function_\">then</span>(resolve, reject);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Promise 是 ES6 异步编程的核心，很多库的异步都从回调向 Promise 转变，Promise 在前端领域发挥着越来越重要的作用；掌握 Promise 的正确使用、理解 Promise 的实现成为了现代前端开发者不可或缺的技能。</p>\n<!--\n### Promise 是什么\n\n### Promise 如何使用\n\n### Promise 什么场景|时候使用\n-->\n\n<h2 id=\"Promise-的核心原理实现\"><a href=\"#Promise-的核心原理实现\" class=\"headerlink\" title=\"Promise 的核心原理实现\"></a>Promise 的核心原理实现</h2><p>首先我们从 Promise 的定义和使用方式开始分析 Promise。</p>\n<h3 id=\"Promise-的使用分析\"><a href=\"#Promise-的使用分析\" class=\"headerlink\" title=\"Promise 的使用分析\"></a>Promise 的使用分析</h3><p>Promise 是一个类，在执行这个类的时候，需要传递一个执行器参数，执行器会立即执行。</p>\n<h4 id=\"Promise-的三个状态\"><a href=\"#Promise-的三个状态\" class=\"headerlink\" title=\"Promise 的三个状态\"></a>Promise 的三个状态</h4><ul>\n<li>pending → 等待</li>\n<li>fulfilled → 成功</li>\n<li>rejected → 失败</li>\n</ul>\n<h4 id=\"状态切换\"><a href=\"#状态切换\" class=\"headerlink\" title=\"状态切换\"></a>状态切换</h4><ul>\n<li>pending → fulfilled</li>\n<li>pending → rejected</li>\n</ul>\n<h4 id=\"一旦状态发生改变，状态将不可变\"><a href=\"#一旦状态发生改变，状态将不可变\" class=\"headerlink\" title=\"一旦状态发生改变，状态将不可变\"></a>一旦状态发生改变，状态将不可变</h4><ul>\n<li>执行器中的两个参数，分别是 resolve 和 reject，其实就是两个回调函数，调用 resolve 是从 pending 状态转变为 fulfilled 状态，调用 reject 是从 pending 状态转变为 rejected 状态。传递给这两个回调函数的参数会作为成功或失败的值。</li>\n<li>Promise 实例对象具有一个 then 方法，该方法接受两个回调函数，分别来处理成功与失败的状态，then 方法内部会进行判断，然后根据当前的状态调用对应的回调函数。then 方法应该是被定义在原型对象中的。</li>\n<li>then 的回调函数中都包含一个值，如果是成功，表示成功后返回的值；如果是失败，就表示失败的原因。</li>\n</ul>\n<h3 id=\"MyPromise-的实现\"><a href=\"#MyPromise-的实现\" class=\"headerlink\" title=\"MyPromise 的实现\"></a>MyPromise 的实现</h3><p>根据上述分析，我们可以给出如下实现：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 所有状态</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Promise 本质上是一个类</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 实例化Promise时需要一个执行器回调，该回调立即执行</span></span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//   Promise 的初始状态;</span></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 记录成功与失败的值</span></span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 此处使用箭头函数为了解决resolve调用中this的指向问题</span></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果状态不是 PENDING 直接跳出该逻辑</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为 成功</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将 resolve 回调的参数进行保存</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为失败</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 保存失败的原因</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 根据当前状态指定回调</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将成功的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将失败的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>接下来我们给出一段验证代码：</p>\n<p><strong>验证 resolve</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>验证 reject</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;Hello Promise Reject~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Reject~</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>验证状态不可变</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">  <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;Hello Promise Reject~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>测试异步</strong></p>\n<p>上述简易版 Promise 中如果存在异步操作将无法正确处理</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./my-promise&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resole, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n<p>上述代码将不会有任何输出</p>\n<p><strong>原因分析</strong></p>\n<ul>\n<li>MyPromise 的实现中没有考虑异步的实现，在异步函数中修改 Promise 的状态后没有调用 then 回调</li>\n<li>then 回调先于 resolve&#x2F;reject 执行，此时 Promise 的状态还处于 PENDING，将不会执行任何操作[MyPromise 中未对该阶段进行处理]</li>\n</ul>\n<h3 id=\"在-Promise-中加入异步操作\"><a href=\"#在-Promise-中加入异步操作\" class=\"headerlink\" title=\"在 Promise 中加入异步操作\"></a>在 Promise 中加入异步操作</h3><p>根据 <code>原因分析</code> 给出如下解决办法：</p>\n<ol>\n<li>创建 <code>onFulfilled</code> 和 <code>onRejected</code> 两个属性用来存储 then 中的回调</li>\n<li>为 <code>then</code> 方法添加状态为 <code>PENDING</code> 的处理逻辑，及时将 onFulfilled 和 onRejected 回调进行存储，便于在异步方法中调用 resolve&#x2F;reject 变更状态时及时触发对应的 then 中的回调</li>\n<li>在成功或失败时及时调用对应的 onFulfilled 或者 onRejected 回调</li>\n</ol>\n<p>增加异步操作的 Promise 实现如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 实例化Promise时需要一个执行器回调，该回调立即执行</span></span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">//   Promise 的初始状态;</span></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 记录成功与失败的值</span></span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// then中的onFulfilled和onRejected回调</span></span><br><span class=\"line\">  onFulfilled = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  onRejected = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 此处使用箭头函数为了解决resolve调用中this的指向问题</span></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果状态不是 PENDING 直接跳出该逻辑</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为 成功</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将 resolve 回调的参数进行保存</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果状态变更为 成功，调用成功的回调</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将状态修改为失败</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 保存失败的原因</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果状态变更为 失败，调用失败的回调</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 根据当前状态指定回调</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将成功的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将失败的值作为回调函数的参数返回</span></span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 既不是成功也不是失败。这个时候保存传递进来的两个回调，便于 异步操作中 更新 Promise 状态时，触发对应的回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span> = onFulfilled;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span> = onRejected;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证多次 then 调用</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; first.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; second.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; third.&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 3s后输出： Hello Promise Resolve~ third.</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>原因分析</strong></p>\n<p>如果执行器中存在<strong>异步逻辑</strong>，<code>then 函数又先于 异步逻辑 执行</code>，导致多次 <code>then</code> 调用存在覆盖 bug，即在后面的 then 调用会覆盖前面的 <code>then</code> 回调</p>\n<h3 id=\"实现-then-方法的多次调用\"><a href=\"#实现-then-方法的多次调用\" class=\"headerlink\" title=\"实现 then 方法的多次调用\"></a>实现 then 方法的多次调用</h3><p>根据 <code>原因分析</code> 给出如下解决方案：</p>\n<ol>\n<li>将保存 <code>then</code> 回调的 onFulfilled 和 onRejected 属性改为数组形式，便于存储多个 <code>then</code> 回调.</li>\n</ol>\n<p>增加存储多次 then 回调的实现如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证多次 then 调用</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; first.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; second.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; third.&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// 立即输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ first.</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ second.</span></span><br><span class=\"line\"><span class=\"comment\">// 1s后输出</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ third.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; first.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; second.&#x27;</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\">promise.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; third.&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// 2s后输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ first.</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ second.</span></span><br><span class=\"line\"><span class=\"comment\">// 3s后输出</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ third.</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"实现-then-方法的链式调用-难点\"><a href=\"#实现-then-方法的链式调用-难点\" class=\"headerlink\" title=\"实现 then 方法的链式调用[难点]\"></a><text style=\"color: red;\">实现 then 方法的链式调用[难点]</text></h3><p><strong>要想实现 then 的链式调用，主要需要解决两个问题：</strong></p>\n<ol>\n<li>返回的是一个新的 <code>MyPromise</code> 的实例；</li>\n<li><code>then</code> 的返回值作为下一次的链式调用的参数。</li>\n</ol>\n<p><strong>这里分为两种情况：</strong></p>\n<ol>\n<li>直接返回一个值，可以直接作为值使用；</li>\n<li>返回一个新的 <code>MyPromise</code> 实例，此时就需要判断其状态；</li>\n</ol>\n<p><strong>代码实现</strong>：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 如果result是一个普通值，直接resolve(result)</span></span><br><span class=\"line\">        <span class=\"comment\">// 如果是一个 MyPromise 实例，根据返回的解决来决定时调用 resolve 还是 reject</span></span><br><span class=\"line\">        <span class=\"title function_\">resolvePromise</span>(result, resolve, reject);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">        <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolvePromise</span>(<span class=\"params\">result, resolve, reject</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">    result.<span class=\"title function_\">then</span>(resolve, reject);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证链式调用</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">const</span> promise2 = promise1.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; promise1.&#x27;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 当前 Promise 的 resolve 回调函数的返回值将作为下一个链式调用的 then 中的 onFulfilled 回调函数的参数值</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&#x27;Hello Promise2 Resolve~&#x27;</span>;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">promise2.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"comment\">// 此处的 value 即为 &#x27;Hello Promise2 Resolve~&#x27;</span></span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ promise1.</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise2 Resolve~ promise2.</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"then-方法链式调用识别-Promise-对象自返回-难点\"><a href=\"#then-方法链式调用识别-Promise-对象自返回-难点\" class=\"headerlink\" title=\"then 方法链式调用识别 Promise 对象自返回 [难点]\"></a>then 方法链式调用识别 Promise 对象自返回 [难点]</h3><p>在 Promise 中，如果 <code>then</code> 方法返回的是自己的 <code>Promise</code> 对象，则会发生 <code>Promise</code> 的嵌套，这个时候程序会报错。</p>\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> p1 = <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"number\">12</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">const</span> p2 = p1.<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">v</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(v);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> p2;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">p2.<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">v</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(v));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// 12</span></span><br><span class=\"line\"><span class=\"comment\">// Promise &#123;&lt;rejected&gt;: TypeError: Chaining cycle detected for promise #&lt;Promise&gt;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">// Uncaught (in promise) TypeError: Chaining cycle detected for promise #&lt;Promise&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>解决办法</strong></p>\n<p>只需判断 <code>then</code> 返回的 Promise 实例与 then 中回调函数返回的实例是否是同一个即可，如果是引用的同一个实例，那么就抛出错误</p>\n<p><strong>实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">        <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolvePromise</span>(<span class=\"params\">promise, result, resolve, reject</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (promise === result) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这里调用reject，并抛出一个Error</span></span><br><span class=\"line\">    <span class=\"comment\">// return 是必须的，阻止程序向下执行</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">reject</span>(</span><br><span class=\"line\">      <span class=\"keyword\">new</span> <span class=\"title class_\">TypeError</span>(<span class=\"string\">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断 result 是不是 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject</span></span><br><span class=\"line\">      result.<span class=\"title function_\">then</span>(resolve, reject);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里 then 方法中的 setTimeout 的作用并不是延迟执行，而是为了调用 resolvePromise 函数时，保证创建的 promise 存在。</p>\n</blockquote>\n<p><strong>验证代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;Hello Promise Resolve~&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">const</span> promise2 = promise1.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">&#x27; promise1.&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise2;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">promise2.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason + <span class=\"string\">` promise2.`</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">);</span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Hello Promise Resolve~ promise1.</span></span><br><span class=\"line\"><span class=\"comment\">// TypeError: Chaining cycle detected for promise #&lt;Promise&gt; promise2.</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"捕捉错误及-then-链式调用其他状态代码补充\"><a href=\"#捕捉错误及-then-链式调用其他状态代码补充\" class=\"headerlink\" title=\"捕捉错误及 then 链式调用其他状态代码补充\"></a>捕捉错误及 then 链式调用其他状态代码补充</h2><p>到目前为止我们实现的 Promise 并没有对异常做任何处理，为了保证代码的健壮性，我们需要对异常做一些处理。</p>\n<h3 id=\"捕捉执行器报错\"><a href=\"#捕捉执行器报错\" class=\"headerlink\" title=\"捕捉执行器报错\"></a>捕捉执行器报错</h3><p>如果执行器函数在执行过程中发生了异常，需要捕获异常并且在捕获逻辑中调用 reject 将异常传出去</p>\n<p><strong>关键实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&#x27;执行器异常&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise1.<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// Error: 执行器异常</span></span><br><span class=\"line\"><span class=\"comment\">//     at E:\\blog\\source\\_posts\\my-promise.js:100:11</span></span><br><span class=\"line\"><span class=\"comment\">//     at new MyPromise (E:\\blog\\source\\_posts\\my-promise.js:14:13)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Object.&lt;anonymous&gt; (E:\\blog\\source\\_posts\\my-promise.js:99:18)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Module._compile (node:internal/modules/cjs/loader:1126:14)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Object.Module._extensions..js (node:internal/modules/cjs/loader:1180:10)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Module.load (node:internal/modules/cjs/loader:1004:32)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Function.Module._load (node:internal/modules/cjs/loader:839:12)</span></span><br><span class=\"line\"><span class=\"comment\">//     at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)</span></span><br><span class=\"line\"><span class=\"comment\">//     at node:internal/main/run_main_module:17:47</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"捕捉-then-中的报错\"><a href=\"#捕捉-then-中的报错\" class=\"headerlink\" title=\"捕捉 then 中的报错\"></a>捕捉 then 中的报错</h3><p>如果需要捕获 <code>then</code> 中的异常，与执行器中同理，需要在 then 中将捕获到的异常通过 reject 传递出去，异常需要通过 <code>try...catch</code> 捕获。</p>\n<p><strong>关键实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将成功的值作为参数返回</span></span><br><span class=\"line\">          <span class=\"comment\">// 保存执行回调函数的结果</span></span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">// 如果返回的是一个普通的值，直接调用resolve</span></span><br><span class=\"line\">          <span class=\"comment\">// 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject</span></span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">          <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将失败的原因作为参数返回</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(onFulfilled);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(onRejected);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> promise1 = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"title class_\">Math</span>.<span class=\"property\">PI</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">promise1</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">pi</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">2</span> * pi * r), <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 输出：</span></span><br><span class=\"line\"><span class=\"comment\">// ReferenceError: r is not defined</span></span><br><span class=\"line\"><span class=\"comment\">//     at E:\\blog\\source\\_posts\\my-promise.js:112:40</span></span><br><span class=\"line\"><span class=\"comment\">//     at Timeout._onTimeout (E:\\blog\\source\\_posts\\my-promise.js:64:40)</span></span><br><span class=\"line\"><span class=\"comment\">//     at listOnTimeout (node:internal/timers:559:17)</span></span><br><span class=\"line\"><span class=\"comment\">//     at processTimers (node:internal/timers:502:7)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"错误与异步状态的链式调用\"><a href=\"#错误与异步状态的链式调用\" class=\"headerlink\" title=\"错误与异步状态的链式调用\"></a>错误与异步状态的链式调用</h3><p>目前只对成功状态的 then 进行了链式调用以及错误处理，错误与异步状态未进行处理，参照成功状态下的错误处理进行实现</p>\n<p><strong>关键实现代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将成功的值作为参数返回</span></span><br><span class=\"line\">          <span class=\"comment\">// 保存执行回调函数的结果</span></span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"comment\">// 如果返回的是一个普通的值，直接调用resolve</span></span><br><span class=\"line\">          <span class=\"comment\">// 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject</span></span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">          <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将失败的原因作为参数返回</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 失败的处理同成功处理，只是调用的回调函数不同</span></span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">          <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">          <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(value);</span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(reason);</span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyPromise</span> = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;./myPromise&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">let</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">setTimeout</span>(resolve, <span class=\"number\">2000</span>, <span class=\"string\">&#x27;成功&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"comment\">// 第一个then方法中的错误要在第二个then方法中捕获到</span></span><br><span class=\"line\">promise</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;resolve&#x27;</span>, value);</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&#x27;then的执行过程中遇到异常&#x27;</span>);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"literal\">null</span>, <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason.<span class=\"property\">message</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"><span class=\"comment\">/* 输出</span></span><br><span class=\"line\"><span class=\"comment\">    resolve 成功</span></span><br><span class=\"line\"><span class=\"comment\">    then的执行过程中遇到异常</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"将-then-方法的参数变成可选参数\"><a href=\"#将-then-方法的参数变成可选参数\" class=\"headerlink\" title=\"将 then 方法的参数变成可选参数\"></a>将 then 方法的参数变成可选参数</h2><p>Promise 中的 then 方法其实是两个<em>可选参数</em>，如果我们不传递任何参数的话，里面的结果是向下传递的，直到捕获为止。</p>\n<p><strong>示例代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value));</span><br><span class=\"line\"><span class=\"comment\">// 最后一个then输入100</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>这段代码可以理解为</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">resolve</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value));</span><br></pre></td></tr></table></figure>\n\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// then方法的实现</span></span><br><span class=\"line\">then (onFulfilled, onRejected) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递</span></span><br><span class=\"line\">    onFulfilled = onFulfilled ? onFulfilled : <span class=\"function\"><span class=\"params\">value</span> =&gt;</span> value</span><br><span class=\"line\">    <span class=\"comment\">// 同理</span></span><br><span class=\"line\">    onRejected = onRejected ? onRejected : <span class=\"function\"><span class=\"params\">reason</span> =&gt;</span> &#123; <span class=\"keyword\">throw</span> reason &#125;</span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个MyPromise实例</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 判断当前状态,根据状态调用指定回调</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;...</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;...</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Promise-all-方法的实现\"><a href=\"#Promise-all-方法的实现\" class=\"headerlink\" title=\"Promise.all 方法的实现\"></a>Promise.all 方法的实现</h2><p>简单的说 <code>Promise.all()</code> 会将多个 Promise 实例包装为一个 Promise 实例，且顺序与调用顺序一致:<br><strong>示例代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p2&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">Promise</span>.<span class=\"title function_\">all</span>([<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"title function_\">p1</span>(), <span class=\"title function_\">p2</span>(), <span class=\"string\">&#x27;c&#x27;</span>]).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">result</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(result);</span><br><span class=\"line\">  <span class=\"comment\">// [&quot;a&quot;, &quot;b&quot;, &quot;p1&quot;, &quot;p2&quot;, &quot;c&quot;]</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<p>在这段代码中，我们的 p1 的执行是延迟了 2s 的，这里如果不使用 Promise.all()的话最终顺序是与我们调用不同的。</p>\n<p><strong>分析 Promise.all 的实现思路</strong></p>\n<ul>\n<li><code>all()</code> 方法是通过类直接调用的，所以是一个静态方法</li>\n<li><code>all()</code> 方法接收一个数组，数组中的值可以是一个普通值，也可以是一个 MyPromise 实例</li>\n<li>return 一个新的 MyPromise 实例</li>\n<li>遍历数组中的每一个值，判断值的类型，如果是一个普通值就直接将值存入一个结果数组；如果是一个 MyPromise 实例对象，会调用其 then 方法，然后根据执行后的状态，如果失败的话调用 MyPromise 的 reject 方法，如果成功的话将值存入结果数组；</li>\n<li>存入数组时计数，如果存入的数量达到传入的数组长度，说明调用完毕，执行 <code>resolve</code> 并将最终的结果数组作为参数返回。</li>\n</ul>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"property\">all</span> = <span class=\"function\">(<span class=\"params\">array</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 用于存放最终结果的数组</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> result = [];</span><br><span class=\"line\">  <span class=\"comment\">// 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 返回一个 MyPromise 实例</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">function</span> <span class=\"title function_\">addResult</span>(<span class=\"params\">result, index, value, resolve</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 根据索引值，将结果推入数组中</span></span><br><span class=\"line\">      result[index] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (++count === array.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 将执行结果返回</span></span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 遍历传入的数组</span></span><br><span class=\"line\">    array.<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">item, index</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (item <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">        item.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">          <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"title function_\">addResult</span>(result, index, value, resolve);</span><br><span class=\"line\">          &#125;,</span><br><span class=\"line\">          <span class=\"comment\">// 如果失败直接返回失败原因</span></span><br><span class=\"line\">          <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(reason);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">addResult</span>(result, index, item, resolve);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试示例</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p2&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">all</span>([<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"title function_\">p1</span>(), <span class=\"title function_\">p2</span>(), <span class=\"string\">&#x27;c&#x27;</span>]).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">result</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(result);</span><br><span class=\"line\">  <span class=\"comment\">// [&quot;a&quot;, &quot;b&quot;, &quot;p1&quot;, &quot;p2&quot;, &quot;c&quot;]</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Promise-resolve-方法的实现\"><a href=\"#Promise-resolve-方法的实现\" class=\"headerlink\" title=\"Promise.resolve 方法的实现\"></a>Promise.resolve 方法的实现</h2><p>关于 Promise.resolve()方法的用法可以参考 Promise.resolve()与 Promise.reject()。<br><strong>直线思路分析</strong></p>\n<ul>\n<li>该方法是一个静态方法</li>\n<li>该方法接收的如果是一个值就直接将该值包装为一个 MyPromise 实例对象返回,如果是一个 MyPromise 实例对象,则直接返回</li>\n</ul>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"property\">resolve</span> = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果是MyPromise的实例，就直接返回这个实例</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (value <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果不是的话创建一个MyPromise实例，并返回传递的值</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> <span class=\"title function_\">resolve</span>(value));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p2&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">p1</span>()).<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"number\">3.1415926</span>).<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"><span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">p2</span>()).<span class=\"title function_\">then</span>(<span class=\"variable language_\">console</span>.<span class=\"property\">log</span>, <span class=\"variable language_\">console</span>.<span class=\"property\">log</span>);</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// p1</span></span><br><span class=\"line\"><span class=\"comment\">// 3.1415926</span></span><br><span class=\"line\"><span class=\"comment\">// 2s后输出</span></span><br><span class=\"line\"><span class=\"comment\">// p2</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"finally-方法的实现\"><a href=\"#finally-方法的实现\" class=\"headerlink\" title=\"finally 方法的实现\"></a>finally 方法的实现</h2><p><strong>实现思路分析</strong></p>\n<ul>\n<li>不管 Promise 是 Fulfilled 还是 Rejected 状态,都会调用 finally 函数中的回调参数</li>\n<li>返回一个新的 Promise 实例</li>\n</ul>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">finally</span>(<span class=\"params\">callback</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">        <span class=\"function\"><span class=\"params\">value</span> =&gt;</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> value),</span><br><span class=\"line\">        <span class=\"function\"><span class=\"params\">reason</span> =&gt;</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123; <span class=\"keyword\">throw</span> reason &#125;)</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p1</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(<span class=\"string\">&#x27;p1&#x27;</span>);</span><br><span class=\"line\">    &#125;, <span class=\"number\">2000</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p2</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">reject</span>(<span class=\"string\">&#x27;p2 reject&#x27;</span>);</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title function_\">p2</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">finally</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;finally p2&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">p1</span>();</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(</span><br><span class=\"line\">    <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  );</span><br><span class=\"line\"><span class=\"comment\">// finally p2</span></span><br><span class=\"line\"><span class=\"comment\">// 两秒之后执行p2 reject</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"catch-方法的实现\"><a href=\"#catch-方法的实现\" class=\"headerlink\" title=\"catch 方法的实现\"></a>catch 方法的实现</h2><p>关于 catch 方法可以参考 catch()，实现该方法其实非常简单，只需要在内部调用 then 方法，不传递第一个回调函数即可</p>\n<p><strong>关键实现</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">catch</span>(callback) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(<span class=\"literal\">null</span>, callback);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">p</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">reject</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">Error</span>(<span class=\"string\">&#x27;reject&#x27;</span>));</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"title function_\">p</span>()</span><br><span class=\"line\">  .<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value);</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  .<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(reason));</span><br><span class=\"line\"><span class=\"comment\">// 输出</span></span><br><span class=\"line\"><span class=\"comment\">// Error: reject</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 定义所有状态常量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">PENDING</span> = <span class=\"string\">&#x27;pending&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">FULFILLED</span> = <span class=\"string\">&#x27;fulfilled&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">REJECTED</span> = <span class=\"string\">&#x27;rejected&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Promise是一个类</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">MyPromise</span> &#123;</span><br><span class=\"line\">  <span class=\"title function_\">constructor</span>(<span class=\"params\">executor</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">executor</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">resolve</span>, <span class=\"variable language_\">this</span>.<span class=\"property\">reject</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  status = <span class=\"variable constant_\">PENDING</span>;</span><br><span class=\"line\">  value = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">  reason = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  onFulfilled = [];</span><br><span class=\"line\">  onRejected = [];</span><br><span class=\"line\"></span><br><span class=\"line\">  resolve = <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">FULFILLED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">value</span> = value;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  reject = <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> !== <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">status</span> = <span class=\"variable constant_\">REJECTED</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">reason</span> = reason;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">shift</span>()(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  then = <span class=\"function\">(<span class=\"params\">onFulfilled, onRejected</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果传递函数，就是用传递的函数，否则指定一个默认值，用于参数传递</span></span><br><span class=\"line\">    onFulfilled = onFulfilled ? onFulfilled : <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> value;</span><br><span class=\"line\">    <span class=\"comment\">// 同理</span></span><br><span class=\"line\">    onRejected = onRejected</span><br><span class=\"line\">      ? onRejected</span><br><span class=\"line\">      : <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">throw</span> reason;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// then 方法返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> promise = <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">FULFILLED</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果不用异步是拿不到 then 中生成的新 Promise 实例的</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 将成功的值作为参数返回</span></span><br><span class=\"line\">            <span class=\"comment\">// 保存执行回调函数的结果</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">value</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// 如果返回的是一个普通的值，直接调用resolve</span></span><br><span class=\"line\">            <span class=\"comment\">// 如果是一个MyPromise实例，根据返回的promise实例状态来决定是调用resolve，还是reject</span></span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 将失败的原因作为参数返回</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">REJECTED</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 失败的处理同成功处理，只是调用的回调函数不同</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">reason</span>);</span><br><span class=\"line\">            <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">          &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">            <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">status</span> === <span class=\"variable constant_\">PENDING</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 表示既不是成功，也不是失败。这个时候保存传递进来的两个回调</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onFulfilled</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> result = <span class=\"title function_\">onFulfilled</span>(value);</span><br><span class=\"line\">              <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">              <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">onRejected</span>.<span class=\"title function_\">push</span>(<span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">const</span> result = <span class=\"title function_\">onRejected</span>(reason);</span><br><span class=\"line\">              <span class=\"title function_\">resolvePromise</span>(promise, result, resolve, reject);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">              <span class=\"title function_\">reject</span>(error);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> promise;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"title function_\">finally</span>(<span class=\"params\">callback</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">      <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> value),</span><br><span class=\"line\">      <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span></span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>.<span class=\"title function_\">resolve</span>(<span class=\"title function_\">callback</span>()).<span class=\"title function_\">then</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">throw</span> reason;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">catch</span>(callback) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>.<span class=\"title function_\">then</span>(<span class=\"literal\">null</span>, callback);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"title function_\">all</span>(<span class=\"params\">array</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 用于存放最终结果的数组</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> result = [];</span><br><span class=\"line\">    <span class=\"comment\">// 用于计算当前已经执行完的实例的数量，用于指定当前数据项结果在 result 中的索引位置</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 返回一个 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">function</span> <span class=\"title function_\">addResult</span>(<span class=\"params\">result, index, value, resolve</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 根据索引值，将结果推入数组中</span></span><br><span class=\"line\">        result[index] = value;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 执行完毕一个 count+1，如果当前值等于总长度的话说明已经执行结束了，可以直接调用resolve，说明已经成功执行完毕了</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (++count === array.<span class=\"property\">length</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将执行结果返回</span></span><br><span class=\"line\">          <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 遍历传入的数组</span></span><br><span class=\"line\">      array.<span class=\"title function_\">forEach</span>(<span class=\"function\">(<span class=\"params\">item, index</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是 MyPromise 实例，则调用 then 方法，获取该实例的值，并将值存入到 result数组的 index 指定索引中</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (item <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">          item.<span class=\"title function_\">then</span>(</span><br><span class=\"line\">            <span class=\"function\">(<span class=\"params\">value</span>) =&gt;</span> &#123;</span><br><span class=\"line\">              <span class=\"title function_\">addResult</span>(result, index, value, resolve);</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"comment\">// 如果失败直接返回失败原因</span></span><br><span class=\"line\">            <span class=\"function\">(<span class=\"params\">reason</span>) =&gt;</span> &#123;</span><br><span class=\"line\">              <span class=\"title function_\">reject</span>(reason);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          );</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"title function_\">addResult</span>(result, index, item, resolve);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">static</span> <span class=\"title function_\">resolve</span>(<span class=\"params\">value</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果是MyPromise的实例，就直接返回这个实例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (value <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果不是的话创建一个MyPromise实例，并返回传递的值</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">MyPromise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> <span class=\"title function_\">resolve</span>(value));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolvePromise</span>(<span class=\"params\">promise, result, resolve, reject</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果 promise 和 then 的返回值是同一个实例的话，需要抛出异常</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (promise === result) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 这里调用reject，并抛出一个Error</span></span><br><span class=\"line\">    <span class=\"comment\">// return 是必须的，阻止程序向下执行</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">reject</span>(</span><br><span class=\"line\">      <span class=\"keyword\">new</span> <span class=\"title class_\">TypeError</span>(<span class=\"string\">&#x27;Chaining cycle detected for promise #&lt;Promise&gt;&#x27;</span>)</span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断 result 是不是 MyPromise 实例</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (result <span class=\"keyword\">instanceof</span> <span class=\"title class_\">MyPromise</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 如果 result 是 MyPromise 实例的话，需要根据 result 的状态调用 resolve 或者 reject</span></span><br><span class=\"line\">      result.<span class=\"title function_\">then</span>(resolve, reject);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"title function_\">resolve</span>(result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n"},{"title":"排序与搜索","date":"2023-03-03T07:04:00.000Z","_content":"\n## 排序算法\n\n### 冒泡排序\n\n#### 定义\n\n冒泡排序（Bubble Sort）是一种简单直观的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果他们的顺序错误就把他们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。\n\n![冒泡排序](https://www.runoob.com/wp-content/uploads/2019/03/bubbleSort.gif)\n\n#### 算法步骤\n\n```js\nfunction bubbleSort(array, compareFn = defaultCompare) {\n  const { length } = array;\n  // n个元素只需要进行n - 1轮比较\n  for (let i = 0; i < length - 1; i++) {\n    for (let j = 0; j < length - i - 1; j++) {\n      if (compareFn(array[j], array[j + 1])) {\n        let temp = array[j + 1];\n        array[j + 1] = array[j];\n        array[j] = temp;\n      }\n    }\n  }\n}\n```\n\n### 选择排序\n\n### 插入排序\n\n### 归并排序\n\n### 快速排序\n\n### 计数排序\n\n### 基数排序\n\n## 搜索算法\n\n## 随机算法\n","source":"_posts/sort-search.md","raw":"---\n#layout: page\ntitle: 排序与搜索\ndate: 2023-03-03 15:04:00\ntags: [算法]\n---\n\n## 排序算法\n\n### 冒泡排序\n\n#### 定义\n\n冒泡排序（Bubble Sort）是一种简单直观的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果他们的顺序错误就把他们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。\n\n![冒泡排序](https://www.runoob.com/wp-content/uploads/2019/03/bubbleSort.gif)\n\n#### 算法步骤\n\n```js\nfunction bubbleSort(array, compareFn = defaultCompare) {\n  const { length } = array;\n  // n个元素只需要进行n - 1轮比较\n  for (let i = 0; i < length - 1; i++) {\n    for (let j = 0; j < length - i - 1; j++) {\n      if (compareFn(array[j], array[j + 1])) {\n        let temp = array[j + 1];\n        array[j + 1] = array[j];\n        array[j] = temp;\n      }\n    }\n  }\n}\n```\n\n### 选择排序\n\n### 插入排序\n\n### 归并排序\n\n### 快速排序\n\n### 计数排序\n\n### 基数排序\n\n## 搜索算法\n\n## 随机算法\n","slug":"sort-search","published":1,"updated":"2023-06-28T09:32:50.978Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cljfka1kl0007dcv4go3v17zs","content":"<h2 id=\"排序算法\"><a href=\"#排序算法\" class=\"headerlink\" title=\"排序算法\"></a>排序算法</h2><h3 id=\"冒泡排序\"><a href=\"#冒泡排序\" class=\"headerlink\" title=\"冒泡排序\"></a>冒泡排序</h3><h4 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义\"></a>定义</h4><p>冒泡排序（Bubble Sort）是一种简单直观的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果他们的顺序错误就把他们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。</p>\n<p><img src=\"https://www.runoob.com/wp-content/uploads/2019/03/bubbleSort.gif\" alt=\"冒泡排序\"></p>\n<h4 id=\"算法步骤\"><a href=\"#算法步骤\" class=\"headerlink\" title=\"算法步骤\"></a>算法步骤</h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">bubbleSort</span>(<span class=\"params\">array, compareFn = defaultCompare</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> &#123; length &#125; = array;</span><br><span class=\"line\">  <span class=\"comment\">// n个元素只需要进行n - 1轮比较</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; length - <span class=\"number\">1</span>; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> j = <span class=\"number\">0</span>; j &lt; length - i - <span class=\"number\">1</span>; j++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"title function_\">compareFn</span>(array[j], array[j + <span class=\"number\">1</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> temp = array[j + <span class=\"number\">1</span>];</span><br><span class=\"line\">        array[j + <span class=\"number\">1</span>] = array[j];</span><br><span class=\"line\">        array[j] = temp;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"选择排序\"><a href=\"#选择排序\" class=\"headerlink\" title=\"选择排序\"></a>选择排序</h3><h3 id=\"插入排序\"><a href=\"#插入排序\" class=\"headerlink\" title=\"插入排序\"></a>插入排序</h3><h3 id=\"归并排序\"><a href=\"#归并排序\" class=\"headerlink\" title=\"归并排序\"></a>归并排序</h3><h3 id=\"快速排序\"><a href=\"#快速排序\" class=\"headerlink\" title=\"快速排序\"></a>快速排序</h3><h3 id=\"计数排序\"><a href=\"#计数排序\" class=\"headerlink\" title=\"计数排序\"></a>计数排序</h3><h3 id=\"基数排序\"><a href=\"#基数排序\" class=\"headerlink\" title=\"基数排序\"></a>基数排序</h3><h2 id=\"搜索算法\"><a href=\"#搜索算法\" class=\"headerlink\" title=\"搜索算法\"></a>搜索算法</h2><h2 id=\"随机算法\"><a href=\"#随机算法\" class=\"headerlink\" title=\"随机算法\"></a>随机算法</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"排序算法\"><a href=\"#排序算法\" class=\"headerlink\" title=\"排序算法\"></a>排序算法</h2><h3 id=\"冒泡排序\"><a href=\"#冒泡排序\" class=\"headerlink\" title=\"冒泡排序\"></a>冒泡排序</h3><h4 id=\"定义\"><a href=\"#定义\" class=\"headerlink\" title=\"定义\"></a>定义</h4><p>冒泡排序（Bubble Sort）是一种简单直观的排序算法。它重复地走访过要排序的数列，一次比较两个元素，如果他们的顺序错误就把他们交换过来。走访数列的工作是重复地进行直到没有再需要交换，也就是说该数列已经排序完成。</p>\n<p><img src=\"https://www.runoob.com/wp-content/uploads/2019/03/bubbleSort.gif\" alt=\"冒泡排序\"></p>\n<h4 id=\"算法步骤\"><a href=\"#算法步骤\" class=\"headerlink\" title=\"算法步骤\"></a>算法步骤</h4><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">bubbleSort</span>(<span class=\"params\">array, compareFn = defaultCompare</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> &#123; length &#125; = array;</span><br><span class=\"line\">  <span class=\"comment\">// n个元素只需要进行n - 1轮比较</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; length - <span class=\"number\">1</span>; i++) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> j = <span class=\"number\">0</span>; j &lt; length - i - <span class=\"number\">1</span>; j++) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"title function_\">compareFn</span>(array[j], array[j + <span class=\"number\">1</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> temp = array[j + <span class=\"number\">1</span>];</span><br><span class=\"line\">        array[j + <span class=\"number\">1</span>] = array[j];</span><br><span class=\"line\">        array[j] = temp;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"选择排序\"><a href=\"#选择排序\" class=\"headerlink\" title=\"选择排序\"></a>选择排序</h3><h3 id=\"插入排序\"><a href=\"#插入排序\" class=\"headerlink\" title=\"插入排序\"></a>插入排序</h3><h3 id=\"归并排序\"><a href=\"#归并排序\" class=\"headerlink\" title=\"归并排序\"></a>归并排序</h3><h3 id=\"快速排序\"><a href=\"#快速排序\" class=\"headerlink\" title=\"快速排序\"></a>快速排序</h3><h3 id=\"计数排序\"><a href=\"#计数排序\" class=\"headerlink\" title=\"计数排序\"></a>计数排序</h3><h3 id=\"基数排序\"><a href=\"#基数排序\" class=\"headerlink\" title=\"基数排序\"></a>基数排序</h3><h2 id=\"搜索算法\"><a href=\"#搜索算法\" class=\"headerlink\" title=\"搜索算法\"></a>搜索算法</h2><h2 id=\"随机算法\"><a href=\"#随机算法\" class=\"headerlink\" title=\"随机算法\"></a>随机算法</h2>"},{"title":"UI 描述","date":"2023-06-28T10:20:31.000Z","_content":"","source":"_posts/01-Describing-The-UI.md","raw":"---\ntitle: UI 描述\ndate: 2023-06-28 18:20:31\ntags: react\ncategories: [Framework] # 分类\n---\n","slug":"01-Describing-The-UI","published":1,"updated":"2023-06-28T11:00:41.833Z","_id":"cljfkfs5z0003msv4hverbz0t","comments":1,"layout":"post","photos":[],"link":"","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"添加交互","date":"2023-06-28T10:59:01.000Z","_content":"\n### 响应事件\n\n#### 预览\n\n- 编写事件处理函数的不同方法\n- 如何从父组件传递事件处理逻辑\n- 事件如何传播以及如何停止它们\n\n#### 总结\n\n- 可以通过将函数作为 props 传递给元素如 `<button` 来处理事件。\n- 必须传递事件处理函数引用，而非函数调用。\n- 可以单独或者内联定义事件处理函数。\n- 事件处理函数在组件内部定义，所以他们可以访问 props。\n- 可以在父组件中定义事件处理函数，并将其作为 props 传递给子组件。\n- 可以根据特定于应用程序的名称定义事件处理函数的 props。\n- 事件会向上传播。通过事件的第一个参数调用 `e.stopPropagation()` 来阻止这种情况。\n- 事件可能具有不需要的浏览器默认行为。调用 `e.preventDefault()` 来阻止这种情况。\n- 从子组件显示调用事件处理函数 props 是事件传播的另一种优秀替代方案。\n\n### state: 组件的记忆\n\n#### 预览\n\n- 如何使用 `useState` Hook 添加 state 变量。\n- `useState` Hook 返回哪一对值。\n- 如何添加多个 state 变量。\n- 为什么 state 被称作是局部的。\n- 如何保证多个 state 的顺序，简易实现 setState Hook。\n\n#### 总结\n\n- 当一个组件需要在多次渲染之间“记住”某些信息时使用 state 变量。\n- state 变量时通过调用 `useState` Hook 来声明的。\n- Hook 是以 `use` 开头的特殊函数。\n- Hook 可能会让你想起 import：他们需要在非条件语句中使用。调用 Hook 时，包括 `useState` ，仅在组件或另一个 Hook 的顶层被调用才有效。\n- `useState` Hook 返回一对值：当前 state 和更新它的函数。\n- 你可以拥有多个 state 变量。在内部，React 按顺序匹配它们。\n- state 是组件私有的。如果在两个地方中渲染它，则每个副本都有独属于自己的 state。\n\n### 渲染和提交\n\n#### 预览\n\n- 在 React 中渲染的含义是什么\n- 为什么以及什么时候 React 会渲染一个组件\n- 在屏幕上显示组件所涉及的步骤\n- 为什么渲染并不一定会导致 DOM 更新\n\n#### 总结\n\n- 在一个 React 应用中一次屏幕更新都会发生以下三个步骤：\n  - **触发** 一次渲染\n  - **渲染** 组件\n  - **提交** 到 DOM\n- 可以使用严格模式找到组件中的错误\n- 如果渲染结果与上一次一样，那么 React 将不会修改 DOM\n\n### state 如同一张快照\n\n#### 预览\n\n- 设置 state 如何导致重新渲染\n- state 在何时以何种方式更新\n- 为什么 state 不在设置后立即更新\n- 事件处理函数如何获取 state 的一张“快照”\n\n#### 总结\n\n- 设置 state 请求一次新的渲染。\n- React 将 state 存储在组件之外，就像在架子上一样。\n- 当你调用 `useState` 时，React 会为你提供**该次渲染**的一张 state 快照。\n- 变量和事件处理函数不会在重新渲染中**存活**。每次渲染都有自己的事件处理函数。\n- 每次渲染(以及其中的函数)始终看到的是 React 提供给本次渲染的 state 快照。\n- 过去创建的事件处理函数拥有的是创建他们那次渲染中的 state 值。\n\n### 把一系列 state 更新加入队列\n\n#### 预览\n\n- 什么是“批处理”以及 React 如何使用它来处理多个 state 更新。\n- 如何连续多次对同一 state 变量进行更新。\n- 实现一个简易版的 “批处理函数”\n\n#### 总结\n\n- 设置 state 不会更改现有渲染中的变量，但会请求一次新的渲染。\n- React 会在事件处理函数执行完成之后处理 state 更新。这被称为**批处理**。\n- 要在一个事件中多次更新某些 state，你可以使用 `setNumber(n => n + 1)` 更新函数。\n\n### 更新 state 中的 Objects\n\n####\n\n- 如何正确更新 state 中的 object\n- 在不改变嵌套 object 的情况下，如何更新它们\n- 什么是不可变性？如何保证不修改不可变对象\n- 使用 Immer 减少 object 复制带来的重复性工作\n\n#### 总结\n\n- React 中所有的 state 都是不不可变的。\n- 当你在 state 中存储 object 时，改变它们不会触发渲染，而是会改变之前渲染“快照”中的状态。\n- 不是改变对象，而是创建它的新版本，并通过设置它的状态来触发重新呈现。\n- 可以使用对象扩展语法完成简单对象的副本创建。\n- 扩展语法是浅拷贝的:它只复制一层深度。\n- 要更新嵌套对象，需要从要更新的层次位置一直到最上层来创建副本。\n- 如何通过 Immer 降低对象拷贝的重复度。\n\n### 更新 state 中的数组\n\n#### 预览\n\n- 如何添加、删除或者修改 React state 中的数组中的元素\n- 如何更新数组内部的对象\n- 如何通过 Immer 降低数组拷贝的重复度\n\n#### 总结\n\n- 你可以直接将数组放入 state 中，但你不应该直接修改它\n- 不要直接修改数组，而是创建它的一份新的拷贝，然后使用新的数组来更新它的状态\n- 你可以使用 `[...arr, newItem]` 这样的数组展开语法来向数组中添加元素\n- 你可以使用 `filter()` 和 `map()` 来创建一个经过过滤或者变换的数组\n- 你可以使用 Immer 来保持代码简洁\n","source":"_posts/02-Adding-Interactivity.md","raw":"---\ntitle: 添加交互\ndate: 2023-06-28 18:59:01\ntags: react\ncategories: [Framework] # 分类\n---\n\n### 响应事件\n\n#### 预览\n\n- 编写事件处理函数的不同方法\n- 如何从父组件传递事件处理逻辑\n- 事件如何传播以及如何停止它们\n\n#### 总结\n\n- 可以通过将函数作为 props 传递给元素如 `<button` 来处理事件。\n- 必须传递事件处理函数引用，而非函数调用。\n- 可以单独或者内联定义事件处理函数。\n- 事件处理函数在组件内部定义，所以他们可以访问 props。\n- 可以在父组件中定义事件处理函数，并将其作为 props 传递给子组件。\n- 可以根据特定于应用程序的名称定义事件处理函数的 props。\n- 事件会向上传播。通过事件的第一个参数调用 `e.stopPropagation()` 来阻止这种情况。\n- 事件可能具有不需要的浏览器默认行为。调用 `e.preventDefault()` 来阻止这种情况。\n- 从子组件显示调用事件处理函数 props 是事件传播的另一种优秀替代方案。\n\n### state: 组件的记忆\n\n#### 预览\n\n- 如何使用 `useState` Hook 添加 state 变量。\n- `useState` Hook 返回哪一对值。\n- 如何添加多个 state 变量。\n- 为什么 state 被称作是局部的。\n- 如何保证多个 state 的顺序，简易实现 setState Hook。\n\n#### 总结\n\n- 当一个组件需要在多次渲染之间“记住”某些信息时使用 state 变量。\n- state 变量时通过调用 `useState` Hook 来声明的。\n- Hook 是以 `use` 开头的特殊函数。\n- Hook 可能会让你想起 import：他们需要在非条件语句中使用。调用 Hook 时，包括 `useState` ，仅在组件或另一个 Hook 的顶层被调用才有效。\n- `useState` Hook 返回一对值：当前 state 和更新它的函数。\n- 你可以拥有多个 state 变量。在内部，React 按顺序匹配它们。\n- state 是组件私有的。如果在两个地方中渲染它，则每个副本都有独属于自己的 state。\n\n### 渲染和提交\n\n#### 预览\n\n- 在 React 中渲染的含义是什么\n- 为什么以及什么时候 React 会渲染一个组件\n- 在屏幕上显示组件所涉及的步骤\n- 为什么渲染并不一定会导致 DOM 更新\n\n#### 总结\n\n- 在一个 React 应用中一次屏幕更新都会发生以下三个步骤：\n  - **触发** 一次渲染\n  - **渲染** 组件\n  - **提交** 到 DOM\n- 可以使用严格模式找到组件中的错误\n- 如果渲染结果与上一次一样，那么 React 将不会修改 DOM\n\n### state 如同一张快照\n\n#### 预览\n\n- 设置 state 如何导致重新渲染\n- state 在何时以何种方式更新\n- 为什么 state 不在设置后立即更新\n- 事件处理函数如何获取 state 的一张“快照”\n\n#### 总结\n\n- 设置 state 请求一次新的渲染。\n- React 将 state 存储在组件之外，就像在架子上一样。\n- 当你调用 `useState` 时，React 会为你提供**该次渲染**的一张 state 快照。\n- 变量和事件处理函数不会在重新渲染中**存活**。每次渲染都有自己的事件处理函数。\n- 每次渲染(以及其中的函数)始终看到的是 React 提供给本次渲染的 state 快照。\n- 过去创建的事件处理函数拥有的是创建他们那次渲染中的 state 值。\n\n### 把一系列 state 更新加入队列\n\n#### 预览\n\n- 什么是“批处理”以及 React 如何使用它来处理多个 state 更新。\n- 如何连续多次对同一 state 变量进行更新。\n- 实现一个简易版的 “批处理函数”\n\n#### 总结\n\n- 设置 state 不会更改现有渲染中的变量，但会请求一次新的渲染。\n- React 会在事件处理函数执行完成之后处理 state 更新。这被称为**批处理**。\n- 要在一个事件中多次更新某些 state，你可以使用 `setNumber(n => n + 1)` 更新函数。\n\n### 更新 state 中的 Objects\n\n####\n\n- 如何正确更新 state 中的 object\n- 在不改变嵌套 object 的情况下，如何更新它们\n- 什么是不可变性？如何保证不修改不可变对象\n- 使用 Immer 减少 object 复制带来的重复性工作\n\n#### 总结\n\n- React 中所有的 state 都是不不可变的。\n- 当你在 state 中存储 object 时，改变它们不会触发渲染，而是会改变之前渲染“快照”中的状态。\n- 不是改变对象，而是创建它的新版本，并通过设置它的状态来触发重新呈现。\n- 可以使用对象扩展语法完成简单对象的副本创建。\n- 扩展语法是浅拷贝的:它只复制一层深度。\n- 要更新嵌套对象，需要从要更新的层次位置一直到最上层来创建副本。\n- 如何通过 Immer 降低对象拷贝的重复度。\n\n### 更新 state 中的数组\n\n#### 预览\n\n- 如何添加、删除或者修改 React state 中的数组中的元素\n- 如何更新数组内部的对象\n- 如何通过 Immer 降低数组拷贝的重复度\n\n#### 总结\n\n- 你可以直接将数组放入 state 中，但你不应该直接修改它\n- 不要直接修改数组，而是创建它的一份新的拷贝，然后使用新的数组来更新它的状态\n- 你可以使用 `[...arr, newItem]` 这样的数组展开语法来向数组中添加元素\n- 你可以使用 `filter()` 和 `map()` 来创建一个经过过滤或者变换的数组\n- 你可以使用 Immer 来保持代码简洁\n","slug":"02-Adding-Interactivity","published":1,"updated":"2023-06-28T11:00:52.705Z","_id":"cljfltak80005msv4bftfggie","comments":1,"layout":"post","photos":[],"link":"","content":"<h3 id=\"响应事件\"><a href=\"#响应事件\" class=\"headerlink\" title=\"响应事件\"></a>响应事件</h3><h4 id=\"预览\"><a href=\"#预览\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>编写事件处理函数的不同方法</li>\n<li>如何从父组件传递事件处理逻辑</li>\n<li>事件如何传播以及如何停止它们</li>\n</ul>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>可以通过将函数作为 props 传递给元素如 <code>&lt;button</code> 来处理事件。</li>\n<li>必须传递事件处理函数引用，而非函数调用。</li>\n<li>可以单独或者内联定义事件处理函数。</li>\n<li>事件处理函数在组件内部定义，所以他们可以访问 props。</li>\n<li>可以在父组件中定义事件处理函数，并将其作为 props 传递给子组件。</li>\n<li>可以根据特定于应用程序的名称定义事件处理函数的 props。</li>\n<li>事件会向上传播。通过事件的第一个参数调用 <code>e.stopPropagation()</code> 来阻止这种情况。</li>\n<li>事件可能具有不需要的浏览器默认行为。调用 <code>e.preventDefault()</code> 来阻止这种情况。</li>\n<li>从子组件显示调用事件处理函数 props 是事件传播的另一种优秀替代方案。</li>\n</ul>\n<h3 id=\"state-组件的记忆\"><a href=\"#state-组件的记忆\" class=\"headerlink\" title=\"state: 组件的记忆\"></a>state: 组件的记忆</h3><h4 id=\"预览-1\"><a href=\"#预览-1\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>如何使用 <code>useState</code> Hook 添加 state 变量。</li>\n<li><code>useState</code> Hook 返回哪一对值。</li>\n<li>如何添加多个 state 变量。</li>\n<li>为什么 state 被称作是局部的。</li>\n<li>如何保证多个 state 的顺序，简易实现 setState Hook。</li>\n</ul>\n<h4 id=\"总结-1\"><a href=\"#总结-1\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>当一个组件需要在多次渲染之间“记住”某些信息时使用 state 变量。</li>\n<li>state 变量时通过调用 <code>useState</code> Hook 来声明的。</li>\n<li>Hook 是以 <code>use</code> 开头的特殊函数。</li>\n<li>Hook 可能会让你想起 import：他们需要在非条件语句中使用。调用 Hook 时，包括 <code>useState</code> ，仅在组件或另一个 Hook 的顶层被调用才有效。</li>\n<li><code>useState</code> Hook 返回一对值：当前 state 和更新它的函数。</li>\n<li>你可以拥有多个 state 变量。在内部，React 按顺序匹配它们。</li>\n<li>state 是组件私有的。如果在两个地方中渲染它，则每个副本都有独属于自己的 state。</li>\n</ul>\n<h3 id=\"渲染和提交\"><a href=\"#渲染和提交\" class=\"headerlink\" title=\"渲染和提交\"></a>渲染和提交</h3><h4 id=\"预览-2\"><a href=\"#预览-2\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>在 React 中渲染的含义是什么</li>\n<li>为什么以及什么时候 React 会渲染一个组件</li>\n<li>在屏幕上显示组件所涉及的步骤</li>\n<li>为什么渲染并不一定会导致 DOM 更新</li>\n</ul>\n<h4 id=\"总结-2\"><a href=\"#总结-2\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>在一个 React 应用中一次屏幕更新都会发生以下三个步骤：<ul>\n<li><strong>触发</strong> 一次渲染</li>\n<li><strong>渲染</strong> 组件</li>\n<li><strong>提交</strong> 到 DOM</li>\n</ul>\n</li>\n<li>可以使用严格模式找到组件中的错误</li>\n<li>如果渲染结果与上一次一样，那么 React 将不会修改 DOM</li>\n</ul>\n<h3 id=\"state-如同一张快照\"><a href=\"#state-如同一张快照\" class=\"headerlink\" title=\"state 如同一张快照\"></a>state 如同一张快照</h3><h4 id=\"预览-3\"><a href=\"#预览-3\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>设置 state 如何导致重新渲染</li>\n<li>state 在何时以何种方式更新</li>\n<li>为什么 state 不在设置后立即更新</li>\n<li>事件处理函数如何获取 state 的一张“快照”</li>\n</ul>\n<h4 id=\"总结-3\"><a href=\"#总结-3\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>设置 state 请求一次新的渲染。</li>\n<li>React 将 state 存储在组件之外，就像在架子上一样。</li>\n<li>当你调用 <code>useState</code> 时，React 会为你提供<strong>该次渲染</strong>的一张 state 快照。</li>\n<li>变量和事件处理函数不会在重新渲染中<strong>存活</strong>。每次渲染都有自己的事件处理函数。</li>\n<li>每次渲染(以及其中的函数)始终看到的是 React 提供给本次渲染的 state 快照。</li>\n<li>过去创建的事件处理函数拥有的是创建他们那次渲染中的 state 值。</li>\n</ul>\n<h3 id=\"把一系列-state-更新加入队列\"><a href=\"#把一系列-state-更新加入队列\" class=\"headerlink\" title=\"把一系列 state 更新加入队列\"></a>把一系列 state 更新加入队列</h3><h4 id=\"预览-4\"><a href=\"#预览-4\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>什么是“批处理”以及 React 如何使用它来处理多个 state 更新。</li>\n<li>如何连续多次对同一 state 变量进行更新。</li>\n<li>实现一个简易版的 “批处理函数”</li>\n</ul>\n<h4 id=\"总结-4\"><a href=\"#总结-4\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>设置 state 不会更改现有渲染中的变量，但会请求一次新的渲染。</li>\n<li>React 会在事件处理函数执行完成之后处理 state 更新。这被称为<strong>批处理</strong>。</li>\n<li>要在一个事件中多次更新某些 state，你可以使用 <code>setNumber(n =&gt; n + 1)</code> 更新函数。</li>\n</ul>\n<h3 id=\"更新-state-中的-Objects\"><a href=\"#更新-state-中的-Objects\" class=\"headerlink\" title=\"更新 state 中的 Objects\"></a>更新 state 中的 Objects</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>如何正确更新 state 中的 object</li>\n<li>在不改变嵌套 object 的情况下，如何更新它们</li>\n<li>什么是不可变性？如何保证不修改不可变对象</li>\n<li>使用 Immer 减少 object 复制带来的重复性工作</li>\n</ul>\n<h4 id=\"总结-5\"><a href=\"#总结-5\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>React 中所有的 state 都是不不可变的。</li>\n<li>当你在 state 中存储 object 时，改变它们不会触发渲染，而是会改变之前渲染“快照”中的状态。</li>\n<li>不是改变对象，而是创建它的新版本，并通过设置它的状态来触发重新呈现。</li>\n<li>可以使用对象扩展语法完成简单对象的副本创建。</li>\n<li>扩展语法是浅拷贝的:它只复制一层深度。</li>\n<li>要更新嵌套对象，需要从要更新的层次位置一直到最上层来创建副本。</li>\n<li>如何通过 Immer 降低对象拷贝的重复度。</li>\n</ul>\n<h3 id=\"更新-state-中的数组\"><a href=\"#更新-state-中的数组\" class=\"headerlink\" title=\"更新 state 中的数组\"></a>更新 state 中的数组</h3><h4 id=\"预览-5\"><a href=\"#预览-5\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>如何添加、删除或者修改 React state 中的数组中的元素</li>\n<li>如何更新数组内部的对象</li>\n<li>如何通过 Immer 降低数组拷贝的重复度</li>\n</ul>\n<h4 id=\"总结-6\"><a href=\"#总结-6\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>你可以直接将数组放入 state 中，但你不应该直接修改它</li>\n<li>不要直接修改数组，而是创建它的一份新的拷贝，然后使用新的数组来更新它的状态</li>\n<li>你可以使用 <code>[...arr, newItem]</code> 这样的数组展开语法来向数组中添加元素</li>\n<li>你可以使用 <code>filter()</code> 和 <code>map()</code> 来创建一个经过过滤或者变换的数组</li>\n<li>你可以使用 Immer 来保持代码简洁</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"响应事件\"><a href=\"#响应事件\" class=\"headerlink\" title=\"响应事件\"></a>响应事件</h3><h4 id=\"预览\"><a href=\"#预览\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>编写事件处理函数的不同方法</li>\n<li>如何从父组件传递事件处理逻辑</li>\n<li>事件如何传播以及如何停止它们</li>\n</ul>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>可以通过将函数作为 props 传递给元素如 <code>&lt;button</code> 来处理事件。</li>\n<li>必须传递事件处理函数引用，而非函数调用。</li>\n<li>可以单独或者内联定义事件处理函数。</li>\n<li>事件处理函数在组件内部定义，所以他们可以访问 props。</li>\n<li>可以在父组件中定义事件处理函数，并将其作为 props 传递给子组件。</li>\n<li>可以根据特定于应用程序的名称定义事件处理函数的 props。</li>\n<li>事件会向上传播。通过事件的第一个参数调用 <code>e.stopPropagation()</code> 来阻止这种情况。</li>\n<li>事件可能具有不需要的浏览器默认行为。调用 <code>e.preventDefault()</code> 来阻止这种情况。</li>\n<li>从子组件显示调用事件处理函数 props 是事件传播的另一种优秀替代方案。</li>\n</ul>\n<h3 id=\"state-组件的记忆\"><a href=\"#state-组件的记忆\" class=\"headerlink\" title=\"state: 组件的记忆\"></a>state: 组件的记忆</h3><h4 id=\"预览-1\"><a href=\"#预览-1\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>如何使用 <code>useState</code> Hook 添加 state 变量。</li>\n<li><code>useState</code> Hook 返回哪一对值。</li>\n<li>如何添加多个 state 变量。</li>\n<li>为什么 state 被称作是局部的。</li>\n<li>如何保证多个 state 的顺序，简易实现 setState Hook。</li>\n</ul>\n<h4 id=\"总结-1\"><a href=\"#总结-1\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>当一个组件需要在多次渲染之间“记住”某些信息时使用 state 变量。</li>\n<li>state 变量时通过调用 <code>useState</code> Hook 来声明的。</li>\n<li>Hook 是以 <code>use</code> 开头的特殊函数。</li>\n<li>Hook 可能会让你想起 import：他们需要在非条件语句中使用。调用 Hook 时，包括 <code>useState</code> ，仅在组件或另一个 Hook 的顶层被调用才有效。</li>\n<li><code>useState</code> Hook 返回一对值：当前 state 和更新它的函数。</li>\n<li>你可以拥有多个 state 变量。在内部，React 按顺序匹配它们。</li>\n<li>state 是组件私有的。如果在两个地方中渲染它，则每个副本都有独属于自己的 state。</li>\n</ul>\n<h3 id=\"渲染和提交\"><a href=\"#渲染和提交\" class=\"headerlink\" title=\"渲染和提交\"></a>渲染和提交</h3><h4 id=\"预览-2\"><a href=\"#预览-2\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>在 React 中渲染的含义是什么</li>\n<li>为什么以及什么时候 React 会渲染一个组件</li>\n<li>在屏幕上显示组件所涉及的步骤</li>\n<li>为什么渲染并不一定会导致 DOM 更新</li>\n</ul>\n<h4 id=\"总结-2\"><a href=\"#总结-2\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>在一个 React 应用中一次屏幕更新都会发生以下三个步骤：<ul>\n<li><strong>触发</strong> 一次渲染</li>\n<li><strong>渲染</strong> 组件</li>\n<li><strong>提交</strong> 到 DOM</li>\n</ul>\n</li>\n<li>可以使用严格模式找到组件中的错误</li>\n<li>如果渲染结果与上一次一样，那么 React 将不会修改 DOM</li>\n</ul>\n<h3 id=\"state-如同一张快照\"><a href=\"#state-如同一张快照\" class=\"headerlink\" title=\"state 如同一张快照\"></a>state 如同一张快照</h3><h4 id=\"预览-3\"><a href=\"#预览-3\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>设置 state 如何导致重新渲染</li>\n<li>state 在何时以何种方式更新</li>\n<li>为什么 state 不在设置后立即更新</li>\n<li>事件处理函数如何获取 state 的一张“快照”</li>\n</ul>\n<h4 id=\"总结-3\"><a href=\"#总结-3\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>设置 state 请求一次新的渲染。</li>\n<li>React 将 state 存储在组件之外，就像在架子上一样。</li>\n<li>当你调用 <code>useState</code> 时，React 会为你提供<strong>该次渲染</strong>的一张 state 快照。</li>\n<li>变量和事件处理函数不会在重新渲染中<strong>存活</strong>。每次渲染都有自己的事件处理函数。</li>\n<li>每次渲染(以及其中的函数)始终看到的是 React 提供给本次渲染的 state 快照。</li>\n<li>过去创建的事件处理函数拥有的是创建他们那次渲染中的 state 值。</li>\n</ul>\n<h3 id=\"把一系列-state-更新加入队列\"><a href=\"#把一系列-state-更新加入队列\" class=\"headerlink\" title=\"把一系列 state 更新加入队列\"></a>把一系列 state 更新加入队列</h3><h4 id=\"预览-4\"><a href=\"#预览-4\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>什么是“批处理”以及 React 如何使用它来处理多个 state 更新。</li>\n<li>如何连续多次对同一 state 变量进行更新。</li>\n<li>实现一个简易版的 “批处理函数”</li>\n</ul>\n<h4 id=\"总结-4\"><a href=\"#总结-4\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>设置 state 不会更改现有渲染中的变量，但会请求一次新的渲染。</li>\n<li>React 会在事件处理函数执行完成之后处理 state 更新。这被称为<strong>批处理</strong>。</li>\n<li>要在一个事件中多次更新某些 state，你可以使用 <code>setNumber(n =&gt; n + 1)</code> 更新函数。</li>\n</ul>\n<h3 id=\"更新-state-中的-Objects\"><a href=\"#更新-state-中的-Objects\" class=\"headerlink\" title=\"更新 state 中的 Objects\"></a>更新 state 中的 Objects</h3><h4 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h4><ul>\n<li>如何正确更新 state 中的 object</li>\n<li>在不改变嵌套 object 的情况下，如何更新它们</li>\n<li>什么是不可变性？如何保证不修改不可变对象</li>\n<li>使用 Immer 减少 object 复制带来的重复性工作</li>\n</ul>\n<h4 id=\"总结-5\"><a href=\"#总结-5\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>React 中所有的 state 都是不不可变的。</li>\n<li>当你在 state 中存储 object 时，改变它们不会触发渲染，而是会改变之前渲染“快照”中的状态。</li>\n<li>不是改变对象，而是创建它的新版本，并通过设置它的状态来触发重新呈现。</li>\n<li>可以使用对象扩展语法完成简单对象的副本创建。</li>\n<li>扩展语法是浅拷贝的:它只复制一层深度。</li>\n<li>要更新嵌套对象，需要从要更新的层次位置一直到最上层来创建副本。</li>\n<li>如何通过 Immer 降低对象拷贝的重复度。</li>\n</ul>\n<h3 id=\"更新-state-中的数组\"><a href=\"#更新-state-中的数组\" class=\"headerlink\" title=\"更新 state 中的数组\"></a>更新 state 中的数组</h3><h4 id=\"预览-5\"><a href=\"#预览-5\" class=\"headerlink\" title=\"预览\"></a>预览</h4><ul>\n<li>如何添加、删除或者修改 React state 中的数组中的元素</li>\n<li>如何更新数组内部的对象</li>\n<li>如何通过 Immer 降低数组拷贝的重复度</li>\n</ul>\n<h4 id=\"总结-6\"><a href=\"#总结-6\" class=\"headerlink\" title=\"总结\"></a>总结</h4><ul>\n<li>你可以直接将数组放入 state 中，但你不应该直接修改它</li>\n<li>不要直接修改数组，而是创建它的一份新的拷贝，然后使用新的数组来更新它的状态</li>\n<li>你可以使用 <code>[...arr, newItem]</code> 这样的数组展开语法来向数组中添加元素</li>\n<li>你可以使用 <code>filter()</code> 和 <code>map()</code> 来创建一个经过过滤或者变换的数组</li>\n<li>你可以使用 Immer 来保持代码简洁</li>\n</ul>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cljfka1kd0004dcv4bl8s090e","category_id":"cljfka1kk0006dcv49rmw54ns","_id":"cljfka1ko000cdcv46f4ye7f9"},{"post_id":"cljfka1kf0005dcv4f1mhb2yh","category_id":"cljfka1kn0009dcv40mbq6aoa","_id":"cljfka1ko000gdcv4fw3h8d3k"},{"post_id":"cljfltak80005msv4bftfggie","category_id":"cljflv4jr000amsv4b16s7zxv","_id":"cljflv4jr000bmsv4abu7ef7v"},{"post_id":"cljfkfs5z0003msv4hverbz0t","category_id":"cljflv4jr000amsv4b16s7zxv","_id":"cljflv7ic000cmsv4eceeepzg"}],"PostTag":[{"post_id":"cljfka1k70001dcv4fjcld5o2","tag_id":"cljfka1kb0003dcv47mq48ydo","_id":"cljfka1kn000bdcv4hglaex0r"},{"post_id":"cljfka1k70001dcv4fjcld5o2","tag_id":"cljfka1km0008dcv44nqr2j1k","_id":"cljfka1ko000ddcv4gvm2crcu"},{"post_id":"cljfka1kd0004dcv4bl8s090e","tag_id":"cljfka1kn000adcv4gebqayih","_id":"cljfka1ko000fdcv4bicrbx0d"},{"post_id":"cljfka1kf0005dcv4f1mhb2yh","tag_id":"cljfka1ko000edcv45sdt1x84","_id":"cljfka1kp000jdcv4hznf6km0"},{"post_id":"cljfka1kf0005dcv4f1mhb2yh","tag_id":"cljfka1kp000hdcv4humg6o1h","_id":"cljfka1kp000kdcv49qti95pw"},{"post_id":"cljfka1kl0007dcv4go3v17zs","tag_id":"cljfka1kp000idcv47y588qhu","_id":"cljfka1kp000ldcv45o996hbm"},{"post_id":"cljfkfs5z0003msv4hverbz0t","tag_id":"cljfka1kb0003dcv47mq48ydo","_id":"cljfkg0qg0004msv41m2s257l"},{"post_id":"cljfltak80005msv4bftfggie","tag_id":"cljfka1kb0003dcv47mq48ydo","_id":"cljfltyi60006msv41qp2cq6b"}],"Tag":[{"name":"react","_id":"cljfka1kb0003dcv47mq48ydo"},{"name":"framework","_id":"cljfka1km0008dcv44nqr2j1k"},{"name":"文档工具","_id":"cljfka1kn000adcv4gebqayih"},{"name":"ES6","_id":"cljfka1ko000edcv45sdt1x84"},{"name":"Promise","_id":"cljfka1kp000hdcv4humg6o1h"},{"name":"算法","_id":"cljfka1kp000idcv47y588qhu"}]}}